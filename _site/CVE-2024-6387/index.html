<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="41D3N" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="41D3N" /> <title> CVE-2024-6387/CVE-2006-5051/CVE-2008-4109 - Analysis of Vulnerabilities in OpenSSH Server on a glibc-based Linux System - 41D3N </title> <link rel="alternate" href="http://localhost:4444/CVE-2024-6387/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4444/CVE-2024-6387/" /> <meta name="description" content="CVE-2024-6387" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="CVE-2024-6387/CVE-2006-5051/CVE-2008-4109 - Analysis of Vulnerabilities in OpenSSH Server on a glibc-based Linux System | Aiden" /> <meta property="og:title" content="CVE-2024-6387/CVE-2006-5051/CVE-2008-4109 - Analysis of Vulnerabilities in OpenSSH Server on a glibc-based Linux System | Aiden" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4444/CVE-2024-6387/" /> <meta property="og:description" content="CVE-2024-6387" /> <meta property="og:image" content="http://localhost:4444/assets/img/Aiden.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="CVE-2024-6387/CVE-2006-5051/CVE-2008-4109 - Analysis of Vulnerabilities in OpenSSH Server on a glibc-based Linux System | twitter_username" /> <meta name="twitter:url" content="http://localhost:4444/CVE-2024-6387/" /> <meta name="twitter:site" content="@twitter_username" /> <meta name="twitter:creator" content="@twitter_username" /> <meta name="twitter:description" content="CVE-2024-6387" /> <meta name="twitter:image" content="http://localhost:4444/assets/img/Aiden.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4444/feed.xml" title="41D3N" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- for mathjax support --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#1-day">1-DAY</a>, <a class="tag" href="/tags/#exploit">EXPLOIT</a>, <a class="tag" href="/tags/#openssh">OPENSSH</a>, <a class="tag" href="/tags/#linux">LINUX</a> </span> </div> <h1 class="header-title" itemprop="headline">CVE-2024-6387/CVE-2006-5051/CVE-2008-4109 - Analysis of Vulnerabilities in OpenSSH Server on a glibc-based Linux System</h1> <div class="post-meta"> <time datetime="2024-10-15T09:00:00+09:00" itemprop="datePublished"> Oct 15, 2024 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Aiden</span> </span> <time hidden datetime="2024-11-05T09:00:00+09:00" itemprop="dateModified"> Oct 15, 2024 </time> <span hidden itemprop="publisher" itemtype="Person">Aiden</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p align="center"><img src="/assets/img/CVE-2024-6387/openssh.gif" /></p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p align="center"><img src="/assets/img/CVE-2024-6387/openssh.gif" /></p> <h1 id="intro"> <a href="#intro" class="anchor-head"></a> Intro </h1> <p>TOOR íŒ€ í™œë™ì„ í•˜ë©° ë¶„ì„í•˜ê²Œëœ OpenSSH ì›ë°ì´ ì·¨ì•½ì ì— ê´€í•œ ê¸€ì…ë‹ˆë‹¤.</p> <p align="center"><img src="/assets/img/toor.png" /></p> <p><code class="language-plaintext highlighter-rouge">CVE-2024-6387</code>ì€ 7ì›” 1ì¼ì— ê³µê°œëœ <a href="https://en.wikipedia.org/wiki/Qualys">Qualys</a>ì—ì„œ ë°œê²¬í•˜ê³  <code class="language-plaintext highlighter-rouge">OpenSSH</code> ë²„ì „ <code class="language-plaintext highlighter-rouge">9.8/9.8p1</code>ì—ì„œ íŒ¨ì¹˜ëœ ì·¨ì•½ì ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">CVE-2024-6387</code>ì€ <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ì˜ ë³´ì•ˆ íšŒê·€(Security Regression)ë¡œ, íŒ¨ì¹˜ë˜ì—ˆë˜ ì·¨ì•½ì ì´ ì˜ëª»ëœ íŒ¨ì¹˜ë¡œ ì¸í•´ì„œ ì¬ë°œìƒí•œ ì¼€ì´ìŠ¤ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ì˜ ë³´ì•ˆ íšŒê·€ ì·¨ì•½ì ì´ê¸° ë•Œë¬¸ì— í•´ë‹¹ ì·¨ì•½ì ì€ â€œRegreSSHionâ€ì´ë€ ì´ë¦„ìœ¼ë¡œ ë¶ˆë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p> <p>ë‘ ì·¨ì•½ì  ëª¨ë‘ <code class="language-plaintext highlighter-rouge">glibc</code>ë¥¼ ê¸°ë°˜ìœ¼ë¡œë‘” ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ í”„ë¡œê·¸ë¨ì¸ <code class="language-plaintext highlighter-rouge">OpenSSH</code>ì˜ ì„œë²„ í”„ë¡œê·¸ë¨ì— ì¡´ì¬í•˜ëŠ” <code class="language-plaintext highlighter-rouge">SIGALRM</code> ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ì—ì„œ <code class="language-plaintext highlighter-rouge">Async-signal-unsafe</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°œìƒí•˜ê²Œ ë˜ëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤. ì´ë¡œì¸í•´ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡  í•´ë‹¹ ì·¨ì•½ì ìœ¼ë¡œ ì¸í•´ root ê¶Œí•œìœ¼ë¡œ ëŒ€ìƒ ì„œë²„ì— ëŒ€í•œ RCEê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</p> <p>ë³¸ ê¸€ì€ ì„ í–‰ ì—°êµ¬ë¥¼ ì§„í–‰í•˜ì‹  ë‹¤ë¥¸ ì—°êµ¬ì›ë¶„ë“¤ì˜ ê¸€ë“¤ì„ ì½ê³  ì œ ë‚˜ë¦„ ë¶„ì„ì„ ì§„í–‰í•˜ë©° ì·¨ì•½ì ì„ ê³µë¶€í•˜ë©° ì´í•´í•˜ê³  ì •ë¦¬í•´ë³¸ ê²°ê³¼ë¡œ ì‘ì„±í•˜ê²Œëœ ê¸€ì…ë‹ˆë‹¤. ë‚˜ë¦„ì˜ ë¶„ì„ì„ í•´ë´¤ì§€ë§Œ ë§ì§€ ì•ŠëŠ” ë¶€ë¶„ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë©°, ë§Œì•½ ì´ë¥¼ ë°œê²¬í•˜ì…¨ì„ ì‹œ í”¼ë“œë°±í•´ì£¼ì‹œë©´ ì ê·¹ ë°˜ì˜í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì·¨ì•½ì  ë° <code class="language-plaintext highlighter-rouge">PoC</code> ë¶„ì„ì— ë§ì€ ë„ì›€ì´ëœ ìë£ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p> <ul> <li><a href="https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt">https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt</a></li> </ul> <h1 id="vuln"> <a href="#vuln" class="anchor-head"></a> Vuln </h1> <ul> <li>CVE-ID : CVE-2024-6387</li> <li>CWE : <a href="http://cwe.mitre.org/data/definitions/362.html">CWE-362</a>, <a href="http://cwe.mitre.org/data/definitions/364.html">CWE-364</a></li> <li>ì˜í–¥ ë°›ëŠ” ë²„ì „</li> </ul> <table> <tr> <th bgcolor="#00ff7f" style="color:black">ì·¨ì•½í•˜ì§€ ì•Šì€ ë²„ì „</th> <th bgcolor="#fa8072" style="color:black">ì·¨ì•½í•œ ë²„ì „</th> </tr> </table> <table> <tr> <th> Release </th> <th> Status </th> <th> Date </th> </tr> <tr> <td bgcolor="#fa8072" style="color:black"> &lt; 4.4p1 </td> <td> CVE-2006-5051 ë˜ëŠ” CVE-2008-4109ì— ëŒ€í•œ íŒ¨ì¹˜ê°€ ì ìš©ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì·¨ì•½ </td> <td> 2006ë…„ 9ì›” 27ì¼ ì´ì „ </td> </tr> <tr> <td bgcolor="#00ff7f" style="color:black"> 4.4p1 â‰¤ OpenSSH &lt; 8.5p1 </td> <td> Mitigation ì ìš©ìœ¼ë¡œ ì·¨ì•½í•˜ì§€ ì•ŠìŒ </td> <td> 2006ë…„ 9ì›” 27ì¼ ~ 2021ë…„ 3ì›” 3ì¼ </td> </tr> <tr> <td bgcolor="#fa8072" style="color:black"> 8.5p1 â‰¤ OpenSSH &lt; 9.8p1 </td> <td> ì·¨ì•½ì  ì¬ë°œ </td> <td> 2021ë…„ 3ì›” 3ì¼ ~ 2024ë…„ 7ì›” 1ì¼ </td> </tr> <tr> <td bgcolor="#00ff7f" style="color:black"> â‰¥ 9.8p1 </td> <td> íšŒê·€ì— ëŒ€í•œ íŒ¨ì¹˜ ì ìš© </td> <td> 2024ë…„ 7ì›” 1ì¼ ì´í›„ </td> </tr> </table> <p>Reference : <a href="https://en.wikipedia.org/wiki/RegreSSHion">https://en.wikipedia.org/wiki/RegreSSHion</a></p> <h1 id="rca"> <a href="#rca" class="anchor-head"></a> RCA </h1> <p><code class="language-plaintext highlighter-rouge">CVE-2024-6387</code>ì— ëŒ€í•´ ì•Œì•„ë³´ê¸° ì „ ë¨¼ì € <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê³  í•´ë‹¹ ì·¨ì•½ì ì´ ì–´ë–»ê²Œ ì¬ë°œìƒí•˜ê²Œë˜ì—ˆëŠ”ì§€ ì•Œì•„ë´…ì‹œë‹¤.</p> <h2 id="cve-2006-5051"> <a href="#cve-2006-5051" class="anchor-head"></a> CVE-2006-5051 </h2> <p>OpenSSHì˜ ì½”ë“œ ì¤‘ sshd.cì— ì¡´ì¬í•˜ëŠ” <a href="https://github.com/openssh/openssh-portable/blob/V_4_3/sshd.c#L307"><code class="language-plaintext highlighter-rouge">grace_alarm_handler</code></a>ëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ìš”ì²­ì„ í•˜ê³ ë‚˜ì„œ ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë„ë¡ ë¡œê·¸ì¸ì„ í•˜ì§€ ì•Šìœ¼ë©´ ë°œìƒí•˜ëŠ” <code class="language-plaintext highlighter-rouge">SIGALRM</code> ì‹œê·¸ë„ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.</p> <p><code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ëŠ” sshdì˜ <a href="https://github.com/openssh/openssh-portable/blob/V_4_3/sshd.c#L1685"><code class="language-plaintext highlighter-rouge">main</code> í•¨ìˆ˜ì—ì„œ ì„¤ì •</a>ë˜ê³  <code class="language-plaintext highlighter-rouge">sshd_config</code> ì§€ì‹œì–´(LoginGraceTime)ë¡œ ì„¤ì •ëœ ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ê²Œë˜ì—ˆì„ ë•Œ ë°œìƒí•˜ëŠ” <code class="language-plaintext highlighter-rouge">SIGALRM</code> ì‹œê·¸ë„ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í˜¸ì¶œë©ë‹ˆë‹¤.</p> <p>ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ ì‹œë„ í›„ <code class="language-plaintext highlighter-rouge">LoginGraceTime</code>ì´ ì„¤ì •ë˜ì–´ìˆë‹¤ë©´ ì¸ì¦ ì‹œê°„ ì´ˆê³¼(<code class="language-plaintext highlighter-rouge">SIGALRM</code>)ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.</p> <p>ì˜ìƒì— ë‚˜ì˜¨ OpenSSH ë²„ì „ì€ <code class="language-plaintext highlighter-rouge">9.2p</code>ë¡œ <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ì˜ ì‘ë™ì„ ë³´ì—¬ë“œë¦¬ê¸° ìœ„í•´ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p> <video width="100%" height="100%" controls=""> <source src="/assets/videos/CVE-2024-6387/sigalarm_grace.mkv" type="video/webm" /> </video> <p><code class="language-plaintext highlighter-rouge">OpenSSH 4.3</code> ë²„ì „ì˜ <a href="https://github.com/openssh/openssh-portable/blob/V_4_3/sshd.c#L307"><code class="language-plaintext highlighter-rouge">grace_alarm_handler</code></a>ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Signal handler for the alarm after the login grace period has expired.
 */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">grace_alarm_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX no idea how fix this signal handler */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_privsep</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span><span class="p">,</span> <span class="n">SIGALRM</span><span class="p">);</span>

	<span class="cm">/* Log error and exit. */</span>
	<span class="n">fatal</span><span class="p">(</span><span class="s">"Timeout before authentication for %s"</span><span class="p">,</span> <span class="n">get_remote_ipaddr</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div> <p>ë¡œê¹…ì„ ìœ„í•´ <code class="language-plaintext highlighter-rouge">fatal</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">fatal</code> í•¨ìˆ˜ëŠ” <a href="https://github.com/openssh/openssh-portable/blob/V_4_3/fatal.c">fatal.c</a>ì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">fatal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">do_log</span><span class="p">(</span><span class="n">SYSLOG_LEVEL_FATAL</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">cleanup_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">fatal</code> í•¨ìˆ˜ëŠ” ë‹¤ì‹œ ë¡œê¹…ì„ ìœ„í•´ <code class="language-plaintext highlighter-rouge">log.c</code>ì— ìœ„ì¹˜í•œ <a href="https://github.com/openssh/openssh-portable/blob/V_4_3/log.c#L286"><code class="language-plaintext highlighter-rouge">do_log</code></a> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ì œ <code class="language-plaintext highlighter-rouge">do_log</code> ì½”ë“œë¥¼ í™•ì¸í•´ë´…ì‹œë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">do_log</span><span class="p">(</span><span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
		<span class="n">syslog</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">"%.500s"</span><span class="p">,</span> <span class="n">fmtbuf</span><span class="p">);</span>
<span class="p">...</span>
	<span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div> <p>í•´ë‹¹ ì½”ë“œì—ì„œ <code class="language-plaintext highlighter-rouge">syslog</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">glibc</code>ì˜ <code class="language-plaintext highlighter-rouge">syslog</code>ëŠ” ë©”ëª¨ë¦¬ ë²„í¼ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ê¸° ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">malloc</code>ì„ í˜¸ì¶œí•˜ê³  í•¨ìˆ˜ì˜ ëì—ì„œëŠ” í•´ë‹¹ ë©”ëª¨ë¦¬ë¥¼ ì •ë¦¬í•˜ê¸° ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">free</code>í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ë•Œì˜ <a href="https://stackoverflow.com/questions/3941271/why-are-malloc-and-printf-said-as-non-reentrant"><code class="language-plaintext highlighter-rouge">malloc</code></a>ê³¼ <code class="language-plaintext highlighter-rouge">free</code>ëŠ” ë¹„ë™ê¸° ì‹œê·¸ë„ì— ì•ˆì „í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì‹œê·¸ë„ ì²˜ë¦¬ í•¨ìˆ˜ì—ì„œëŠ” í˜¸ì¶œë˜ì–´ì„  ì•ˆë˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">syslog</code>ì˜ í˜¸ì¶œë¡œ ì¸í•´ì„œ ì·¨ì•½ì ì´ ë°œìƒí•œ ìƒí™©ì…ë‹ˆë‹¤.</p> <h2 id="async-signal-safe-function"> <a href="#async-signal-safe-function" class="anchor-head"></a> Async-signal-safe function </h2> <p><code class="language-plaintext highlighter-rouge">Async-signal-safe</code> í•¨ìˆ˜ë€ ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ë‚´ì—ì„œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¥¼ ëœ»í•©ë‹ˆë‹¤.</p> <p>ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ì—ì„œ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ê°€ <code class="language-plaintext highlighter-rouge">async signal safety</code>(ë¹„ë™ê¸° ì‹œê·¸ë„ ì•ˆì „ì„±)ì´ ì—†ì„ ê²½ìš° ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <ul> <li><a href="https://stackoverflow.com/questions/3941271/why-are-malloc-and-printf-said-as-non-reentrant">https://stackoverflow.com/questions/3941271/why-are-malloc-and-printf-said-as-non-reentrant</a></li> </ul> <p><code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ì€ <code class="language-plaintext highlighter-rouge">async-signal-unsafe</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì„œ ë°œìƒí•©ë‹ˆë‹¤. ë°”ë¡œ ì§ì ‘ì ì¸ í˜¸ì¶œì€ ì•„ë‹ˆë©° ìœ„ì—ì„œ ì‚´í´ë³¸ëŒ€ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">async-signal-unsafe</code> í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.</p> <p align="center"><img src="/assets/img/CVE-2024-6387/function_call_diagram.png" /></p> <p>ì´ì™€ ê°™ì€ <code class="language-plaintext highlighter-rouge">SIGALRM</code> í•¸ë“¤ëŸ¬ì˜ í—ˆì ì„ ì´ìš©í•´ <code class="language-plaintext highlighter-rouge">malloc/free</code> í•¨ìˆ˜ ì²˜ë¦¬ ì¤‘ íŠ¹ì • ì§€ì ì—ì„œì˜ ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ê³  <code class="language-plaintext highlighter-rouge">malloc/free</code>ì— ì¬ì§„ì…í•˜ì—¬ ìµìŠ¤í”Œë¡œì‡ì„ ì„±ê³µì‹œí‚µë‹ˆë‹¤.</p> <h2 id="cve-2006-5051-patch-incorrect-fix"> <a href="#cve-2006-5051-patch-incorrect-fix" class="anchor-head"></a> CVE-2006-5051 Patch (Incorrect fix) </h2> <p>ìœ„ì—ì„œ ì•Œì•„ë³¸ ì·¨ì•½ì ì€ <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code> íŒ¨ì¹˜ì— ì˜í•´ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</p> <p><code class="language-plaintext highlighter-rouge">OpenSSH 4.4</code> ë²„ì „ì˜ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p> <p>ë¨¼ì € sshd.cì—ì„œì˜ <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p> <p>4.3p2</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/grace_alarm_handler_4.3p2.png" /></p> <p>4.4</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/grace_alarm_handler_4.4.png" /></p> <p>4.4ì—ì„  <code class="language-plaintext highlighter-rouge">sigdie</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” í˜•íƒœë¡œ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">sigdie</code>ëŠ” ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ê²Œ <code class="language-plaintext highlighter-rouge">do_log</code>ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">sigdie</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">do_log</span><span class="p">(</span><span class="n">SYSLOG_LEVEL_FATAL</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>í•˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">do_log</code>ì—ì„œ ì—¬ì „íˆ <code class="language-plaintext highlighter-rouge">syslog</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” ëª¨ìŠµì´ ë³´ì…ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="kt">void</span>
<span class="nf">do_log</span><span class="p">(</span><span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
		<span class="n">syslog</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">"%.500s"</span><span class="p">,</span> <span class="n">fmtbuf</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>ì˜ëª»ëœ íŒ¨ì¹˜ê°€ ì´ë£¨ì–´ì¡Œê³  í•´ë‹¹ ì·¨ì•½ì ì€ ì—¬ì „íˆ ì¡´ì¬í•˜ëŠ” ìƒíƒœê°€ ë©ë‹ˆë‹¤.</p> <h2 id="cve-2008-4109-patch"> <a href="#cve-2008-4109-patch" class="anchor-head"></a> CVE-2008-4109 Patch </h2> <p>ì•ì„œ ì•Œì•„ë³¸ ì·¨ì•½ì ì€ <a href="https://nvd.nist.gov/vuln/detail/CVE-2008-4109"><code class="language-plaintext highlighter-rouge">CVE-2008-4109</code></a> íŒ¨ì¹˜ì—ì„œ ë¹„ë¡œì†Œ ìˆ˜ì •ë©ë‹ˆë‹¤.</p> <blockquote> <p>A certain Debian patch for OpenSSH before 4.3p2-9etch3 on etch; before 4.6p1-1 on sid and lenny; and on other distributions such as SUSE uses functions that are not async-signal-safe in the signal handler for login timeouts, which allows remote attackers to cause a denial of service (connection slot exhaustion) via multiple login attempts. NOTE: this issue exists because of an incorrect fix for CVE-2006-5051.</p> </blockquote> <p>OpenSSH 4.5p1 <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Signal handler for the alarm after the login grace period has expired.
 */</span>
<span class="cm">/*ARGSUSED*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">grace_alarm_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_privsep</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span><span class="p">,</span> <span class="n">SIGALRM</span><span class="p">);</span>

	<span class="cm">/* Log error and exit. */</span>
	<span class="n">sigdie</span><span class="p">(</span><span class="s">"Timeout before authentication for %s"</span><span class="p">,</span> <span class="n">get_remote_ipaddr</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div> <p>OpenSSH 4.5p1 <code class="language-plaintext highlighter-rouge">sigdie</code></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">sigdie</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,...)</span>
<span class="p">{</span>
<span class="cp">#ifdef DO_LOG_SAFE_IN_SIGHAND
</span>	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">do_log</span><span class="p">(</span><span class="n">SYSLOG_LEVEL_FATAL</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ì—ì„œ í˜¸ì¶œë˜ëŠ” <code class="language-plaintext highlighter-rouge">sigdie</code>ì—ëŠ” ì „ì²˜ë¦¬ ì½”ë“œê°€ ì‚½ì…ë˜ì–´ <code class="language-plaintext highlighter-rouge">DO_LOG_SAFE_IN_SIGHAND</code>ë¥¼ ì •ì˜í•˜ì§€ ì•ŠëŠ”ì´ìƒ <code class="language-plaintext highlighter-rouge">do_log</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” ì¼ì€ ì—†ì–´ì¡ŒìŠµë‹ˆë‹¤.</p> <h2 id="cve-2024-6387-regresshion"> <a href="#cve-2024-6387-regresshion" class="anchor-head"></a> CVE-2024-6387 (RegreSSHion) </h2> <p>ì•ì„œ ì‚´í´ë³¸ ì·¨ì•½ì ì¸ <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ê³¼ <code class="language-plaintext highlighter-rouge">CVE-2008-4109</code>ëŠ” ìœ„ì—ì„œ ì ìš©ëœ <code class="language-plaintext highlighter-rouge">#ifdef DO_LOG_SAFE_IN_SIGHAND</code>ê°€ ì‹¤ìˆ˜ë¡œ ì œê±°ë˜ì–´ <a href="https://github.com/openssh/openssh-portable/commit/752250c"><code class="language-plaintext highlighter-rouge">commit 752250c</code></a>(OpenSSH 8.5p1)ì— ì˜í•´ì„œ ë¶€í™œí•˜ê²Œë©ë‹ˆë‹¤.</p> <p>ì½”ë“œê°€ ì–´ë–»ê²Œ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•´ë´…ì‹œë‹¤.</p> <p>grace_alarm_handler</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Signal handler for the alarm after the login grace period has expired.
 */</span>
<span class="cm">/*ARGSUSED*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">grace_alarm_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_privsep</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">pmonitor</span><span class="o">-&gt;</span><span class="n">m_pid</span><span class="p">,</span> <span class="n">SIGALRM</span><span class="p">);</span>

	<span class="cm">/*
	 * Try to kill any processes that we have spawned, E.g. authorized
	 * keys command helpers.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getpgid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">getpid</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ssh_signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
		<span class="n">kill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX pre-format ipaddr/port so we don't need to access active_state */</span>
	<span class="cm">/* Log error and exit. */</span>
	<span class="n">sigdie</span><span class="p">(</span><span class="s">"Timeout before authentication for %s port %d"</span><span class="p">,</span>
	    <span class="n">ssh_remote_ipaddr</span><span class="p">(</span><span class="n">the_active_state</span><span class="p">),</span>
	    <span class="n">ssh_remote_port</span><span class="p">(</span><span class="n">the_active_state</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">sigdie</code>ëŠ” ë§¤í¬ë¡œë¡œ <code class="language-plaintext highlighter-rouge">sshsigdie</code>ë¡œ í™•ì¥ë©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define sigdie(...)		sshsigdie(__FILE__, __func__, __LINE__, 0, SYSLOG_LEVEL_ERROR, NULL, __VA_ARGS__)
</span></code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">sshsigdie</code>ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë˜ì–´ìˆìŠµë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">sshsigdie</code>ëŠ” <code class="language-plaintext highlighter-rouge">sshlogv</code>ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">sshsigdie</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">showfunc</span><span class="p">,</span>
    <span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">sshlogv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">showfunc</span><span class="p">,</span> <span class="n">SYSLOG_LEVEL_FATAL</span><span class="p">,</span>
	    <span class="n">suffix</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>ê²°ê³¼ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">sshlogv</code>ëŠ” ê·¸ì „ì— íŒ¨ì¹˜ë¡œ í˜¸ì¶œë˜ì§€ ì•Šê²Œí–ˆë˜ <code class="language-plaintext highlighter-rouge">do_log</code>ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ê²Œë©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">sshlogv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">showfunc</span><span class="p">,</span>
    <span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">fmt2</span><span class="p">[</span><span class="n">MSGBUFSIZ</span> <span class="o">+</span> <span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">forced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="s">"%.48s:%.48s():%d"</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="n">file</span> <span class="o">:</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nlog_verbose</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match_pattern_list</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">log_verbose</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">forced</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log_handler</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">forced</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">fmt2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt2</span><span class="p">),</span> <span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">showfunc</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">fmt2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt2</span><span class="p">),</span> <span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmt2</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt2</span><span class="p">));</span>

	<span class="n">do_log</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">forced</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">fmt2</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">do_log</code>ëŠ” ì—¬ì „íˆ <code class="language-plaintext highlighter-rouge">syslog</code>ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìœ¼ë©° <code class="language-plaintext highlighter-rouge">glibc</code>ì˜ <code class="language-plaintext highlighter-rouge">syslog</code>ëŠ” ì—¬ì „íˆ ë¹„ë™ê¸° ì‹œê·¸ë„ì— ëŒ€í•´ ì•ˆì „í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë³´ì•ˆ íšŒê·€ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span>
<span class="nf">do_log</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">force</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
		<span class="n">syslog</span><span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="s">"%.500s"</span><span class="p">,</span> <span class="n">fmtbuf</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>ì´ë¡œì¸í•´ í•´ë‹¹ íŒ¨ì¹˜ê°€ ë„ì…ëœ <code class="language-plaintext highlighter-rouge">8.5p1</code>ë¶€í„° <code class="language-plaintext highlighter-rouge">9.8p1</code> íŒ¨ì¹˜ê°€ ì ìš©ë˜ê¸° ì´ì „ê¹Œì§€ <code class="language-plaintext highlighter-rouge">glibc-based</code> ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œ ì·¨ì•½ì ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</p> <p align="center"><img src="/assets/img/CVE-2024-6387/regresshion_attack.png" /><a href="https://upload.wikimedia.org/wikipedia/commons/8/83/Resultant.png">https://upload.wikimedia.org/wikipedia/commons/8/83/Resultant.png</a></p> <h2 id="exploit"> <a href="#exploit" class="anchor-head"></a> Exploit </h2> <p>ë³¸ ì·¨ì•½ì ì„ ì œë³´í•œ QualysëŠ” ìœ„ ì·¨ì•½ì (CVE-2024-6387)ì˜ ì•…ìš©ë°©ë²•ì„ 32bit glibcê¸°ë°˜ì˜ ë¦¬ëˆ…ìŠ¤ì—ì„œ ì…ì¦í–ˆìŠµë‹ˆë‹¤. ë˜í•œ ë‹¤ë¥¸ ë²„ì „ì—ì„œë„ ì•…ìš© ê°€ëŠ¥ ì§€ì ì„ ì°¾ì•„ íŠ¹ì • ë²„ì „ì— ëŒ€í•œ ì•…ìš© ê°€ëŠ¥ì„±ì„ ì—°êµ¬ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.</p> <p>ì—°êµ¬ ê°œìš”ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p> <h3 id="ssh-20-openssh_34p1-debian-134p1-1woody3-debian-30r6-from-2005"> <a href="#ssh-20-openssh_34p1-debian-134p1-1woody3-debian-30r6-from-2005" class="anchor-head"></a> SSH-2.0-OpenSSH_3.4p1 Debian 1:3.4p1-1.woody.3 (Debian 3.0r6, from 2005) </h3> <p><code class="language-plaintext highlighter-rouge">DSA</code>ì˜ ê³µê°œ í‚¤ íŒŒì‹± ì§€ì ì—ì„œ í˜¸ì¶œë˜ëŠ” <code class="language-plaintext highlighter-rouge">free</code>ë¥¼ ì·¨ì•½ì ì„ ì´ìš©í•´ ì¤‘ê°„ì— ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ê³ , ì™„ì „í•œ ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§€ì§€ ì•Šì€ <code class="language-plaintext highlighter-rouge">heap chunk</code>ì— ëŒ€í•´ <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ì— ì˜í•´ í˜¸ì¶œë˜ëŠ” <code class="language-plaintext highlighter-rouge">free</code>ë¥¼ í†µí•´ ê³µê²©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p> <p>í•´ë‹¹ ê³µê²©ì„ ì„±ê³µì‹œí‚¤ê¸°ìœ„í•´ 600ì´ˆì˜ ë¡œê·¸ì¸ ìœ ì˜ˆ ì‹œê°„ ë™ì•ˆ 10ê°œì˜ ì—°ê²°(MaxStartups)ì„ ìˆ˜ìš©í•  ê²½ìš° ì•½ 10,000ë²ˆì˜ ì‹œë„ê°€ í•„ìš”í•˜ë©° ì›ê²© ë£¨íŠ¸ ì‰˜ì„ ì–»ê¸° ìœ„í•´ í‰ê· ì ìœ¼ë¡œ ì•½ 1ì£¼ì¼ ì •ë„ê°€ ì†Œìš”ë©ë‹ˆë‹¤.</p> <h3 id="ssh-20-openssh_42p1-debian-7ubuntu3-ubuntu-6061-from-2006"> <a href="#ssh-20-openssh_42p1-debian-7ubuntu3-ubuntu-6061-from-2006" class="anchor-head"></a> SSH-2.0-OpenSSH_4.2p1 Debian-7ubuntu3 (Ubuntu 6.06.1, from 2006) </h3> <p>í•´ë‹¹ ë²„ì „ì˜ ì—°êµ¬ì—ì„  <code class="language-plaintext highlighter-rouge">CVE-2006-5051</code>ì—ì„œ ì–¸ê¸‰ëœ <code class="language-plaintext highlighter-rouge">GSSAPI</code>ë¥¼ <code class="language-plaintext highlighter-rouge">GSSAPI</code> ê¸°ëŠ¥ì€ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ë˜ì–´ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— ì·¨ì•½ì ì„ ì•…ìš©í•  í¬ì¸íŠ¸ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ëœ <code class="language-plaintext highlighter-rouge">PAM</code> ê¸°ëŠ¥ì„ ì´ìš©í•©ë‹ˆë‹¤.</p> <p>í•´ë‹¹ ê³µê²©ì„ ì„±ê³µì‹œí‚¤ê¸°ìœ„í•´ 120ì´ˆì˜ ë¡œê·¸ì¸ ìœ ì˜ˆ ì‹œê°„ ë™ì•ˆ 10ê°œì˜ ì—°ê²°(MaxStartups)ì„ ìˆ˜ìš©í•  ê²½ìš° ì•½ 10,000ë²ˆì˜ ì‹œë„ê°€ í•„ìš”í•˜ë©° ì›ê²© ë£¨íŠ¸ ì‰˜ì„ ì–»ê¸° ìœ„í•´ ì•½ 1~2ì¼ ì •ë„ê°€ ì†Œìš”ë©ë‹ˆë‹¤.</p> <h3 id="ssh-20-openssh_92p1-debian-2deb12u2-debian-1250-from-2024"> <a href="#ssh-20-openssh_92p1-debian-2deb12u2-debian-1250-from-2024" class="anchor-head"></a> SSH-2.0-OpenSSH_9.2p1 Debian-2.+deb12u2 (Debian 12.5.0 from 2024) </h3> <blockquote> <p>ğŸ§ª ì•„ë˜ ì„œìˆ ëœ Exploitì€ <code class="language-plaintext highlighter-rouge">_vtable_offset</code>ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° <code class="language-plaintext highlighter-rouge">_IO_wfile_underflow</code>ì˜ ìœ ë„ê°€ ë¶ˆê°€ëŠ¥í•˜ê¸°ë•Œë¬¸ì— glibc 32bitì—ì„œë§Œ ìœ íš¨í•©ë‹ˆë‹¤.</p> </blockquote> <details> <summary>â‰ï¸</summary> <div> <p>ë‹¤ìŒ glibc-2.36ì˜ ì†ŒìŠ¤ ì½”ë“œì˜ ì£¼ì„ì„ í™•ì¸í•´ë´…ì‹œë‹¤.</p> <p>libioP.h</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Setting this macro to 1 enables the use of the _vtable_offset bias
   in _IO_JUMPS_FUNCS, below.  This is only needed for new-format
   _IO_FILE in libc that must support old binaries (see oldfileops.c).  */</span>
<span class="cp">#if SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1) &amp;&amp; !defined _IO_USE_OLD_IO_FILE
# define _IO_JUMPS_OFFSET 1
#else
# define _IO_JUMPS_OFFSET 0
#endif
</span></code></pre></div> </div> <p>ìœ„ì™€ ê°™ì€ ê²½ìš° ì»´íŒŒì¼ ì„¤ì •ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">_IO_JUMPS_OFFSET</code>ì„ <code class="language-plaintext highlighter-rouge">1</code>ë¡œ ë§Œë“¤ì–´ í™œì„±í™”í•˜ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">0</code>ìœ¼ë¡œ ë§Œë“¤ì–´ ì¼ë¶€ ë§¤í¬ë¡œë¥¼ ë‹¤ë¥´ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p>ì´ì—ë”°ë¼ ë‹¤ìŒê³¼ ê°™ì€ ë§¤í¬ë¡œì— ì°¨ì´ê°€ ìƒê¹ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if _IO_JUMPS_OFFSET
# define _IO_JUMPS_FUNC(THIS) \
  (IO_validate_vtable                                                   \
   (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS)	\
			     + (THIS)-&gt;_vtable_offset)))
# define _IO_JUMPS_FUNC_UPDATE(THIS, VTABLE)				\
  (*(const struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS)	\
				  + (THIS)-&gt;_vtable_offset) = (VTABLE))
# define _IO_vtable_offset(THIS) (THIS)-&gt;_vtable_offset
#else
# define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
# define _IO_JUMPS_FUNC_UPDATE(THIS, VTABLE) \
  (_IO_JUMPS_FILE_plus (THIS) = (VTABLE))
# define _IO_vtable_offset(THIS) 0
#endif
</span></code></pre></div> </div> <p>ìœ„ì—ì„œ ë³¸ _IO_JUMPS_OFFSETì„ 0ìœ¼ë¡œ ë§Œë“ ë‹¤ë©´ ì„¤ì •ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">_IO_JUMPS_FUNC</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">_vtable_offset</code> í•„ë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê²Œë˜ê³  ì´ë¡œì¸í•´ì„œ ê³µê²©ì´ í†µí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p>ì´ëŠ” ì› ì—°êµ¬ê¸€ì—ë„ ë‚˜ì™€ìˆìœ¼ë©° ë”°ë¼ì„œ ì•„ë˜ì— ì„¤ëª…í•˜ëŠ” ê³µê²©ì€ i386 glibcì—ë§Œ í•´ë‹¹í•˜ê²Œë©ë‹ˆë‹¤.</p> <blockquote> <p>Eventually, we devised the following technique (which seems to be specific to the i386 glibc â€“ the amd64 glibc does not seem to use _vtable_offset at all):</p> </blockquote> <p>â€“ [ì ‘ì€ê¸€ì˜ ëì…ë‹ˆë‹¤] â€“</p> </div> </details> <p>í•´ë‹¹ ë²„ì „ì˜ ì—°êµ¬ì—ì„  <code class="language-plaintext highlighter-rouge">syslog</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” ì ì„ ì´ìš©í•©ë‹ˆë‹¤. PoCì—ì„  í˜„ì¬ í™˜ê²½ì—ì„œì˜ ì·¨ì•½ì„±ì„ ì¢…í•©í•´ì„œ ì•…ìš©í•˜ê¸° ë•Œë¬¸ì— ìì„¸íˆ ì•Œì•„ë´…ì‹œë‹¤.</p> <p>ì—°êµ¬ì— ì‚¬ìš©ëœ <code class="language-plaintext highlighter-rouge">Debian</code>ì€ i386ì— ê²½ìš° glibc(2.36)ê°€ í•­ìƒ <code class="language-plaintext highlighter-rouge">0xb7200000</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">0xb7400000</code>ì— ë§¤í•‘ë˜ê¸° ë•Œë¬¸ì— ì ˆë°˜ì˜ í™•ë¥ ë¡œ PIEë¥¼ ë¬´ë ¥í™” ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p>ì•ì„œ ì•Œì•„ë³¸ ìˆœì„œë¡œ <code class="language-plaintext highlighter-rouge">syslog</code>ê°€ <code class="language-plaintext highlighter-rouge">grace_alarm_handler</code>ì— ì˜í•´ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.</p> <p>ì—°êµ¬ì— ì‚¬ìš©ëœ <code class="language-plaintext highlighter-rouge">Debian</code>ë²„ì „ì˜ glibc(2.36)ëŠ” <a href="https://sourceware.org/git/?p=glibc.git;a=commit;h=a15d53e2de4c7d83bda251469d92a3c7b49a90db">ë‹¨ì¼ ìŠ¤ë ˆë“œ í™˜ê²½ì—ëŒ€í•œ ë½ì„ ì§„í–‰í•˜ì§€ ì•Šê¸° ë•Œë¬¸</a>ì— ì·¨ì•½ì ì„ ì„±ê³µì ìœ¼ë¡œ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p>ì´ë¥¼ ì´ìš©í•´ <code class="language-plaintext highlighter-rouge">malloc</code> í˜¸ì¶œì„ SIGALRMì„ í†µí•´ ì¤‘ê°„ì— ì¤‘ë‹¨ì‹œí‚¨ í›„ <code class="language-plaintext highlighter-rouge">SIGALRM</code>ì—ì„œ ì‚¬ìš©í•˜ëŠ” <code class="language-plaintext highlighter-rouge">malloc</code>ì„ í†µí•´ ì™„ì „íˆ ì²˜ë¦¬ë˜ì§€ ì•Šì€ <code class="language-plaintext highlighter-rouge">heap chunk</code>ë¥¼ ì•…ìš©í•©ë‹ˆë‹¤.</p> <p>í•´ë‹¹ ê³µê²©ì„ ì„±ê³µì‹œí‚¤ìœ„í•´ 120ì´ˆì˜ ë¡œê·¸ì¸ ìœ ì˜ˆ ì‹œê°„ ë™ì•ˆ 100ê°œì˜ ì—°ê²°(MaxStartups)ì„ ìˆ˜ìš©í•  ê²½ìš° ì›ê²© ë£¨íŠ¸ ì‰˜ì„ ì–»ê¸° ìœ„í•´ ì•½ 6~8ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.</p> <p>glibc 2.36ì—ì„œ <code class="language-plaintext highlighter-rouge">syslog</code>ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ íë¦„ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">fopen</code>ì„ í˜¸ì¶œí•´ <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/call_graph.png" /></p> <details> <summary>/misc/syslog.c:__syslog,__vsyslog_internal</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * syslog, vsyslog --
 *	print message on log file; output is intended for syslogd(8).
 */</span>
<span class="kt">void</span>
<span class="nf">__syslog</span> <span class="p">(</span><span class="kt">int</span> <span class="n">pri</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
  <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

  <span class="n">va_start</span> <span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
  <span class="n">__vsyslog_internal</span> <span class="p">(</span><span class="n">pri</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">va_end</span> <span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">ldbl_hidden_def</span> <span class="p">(</span><span class="n">__syslog</span><span class="p">,</span> <span class="n">syslog</span><span class="p">)</span>
<span class="n">ldbl_strong_alias</span> <span class="p">(</span><span class="n">__syslog</span><span class="p">,</span> <span class="n">syslog</span><span class="p">)</span>

<span class="kt">void</span>
<span class="nf">__vsyslog_internal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">pri</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span><span class="n">now_tmp</span> <span class="o">=</span> <span class="n">__localtime64_r</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now_tm</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <details> <summary>/time/localtime.c:__localtime64_r</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Return the `struct tm' representation of *T in local time,
   using *TP to store the result.  */</span>
<span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span>
<span class="nf">__localtime64_r</span> <span class="p">(</span><span class="k">const</span> <span class="n">__time64_t</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">__tz_convert</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <details> <summary>/time/tzset.c:__tz_convert,tzset_internal</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Return the `struct tm' representation of TIMER in the local timezone.
   Use local time if USE_LOCALTIME is nonzero, UTC otherwise.  */</span>
<span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span>
<span class="nf">__tz_convert</span> <span class="p">(</span><span class="n">__time64_t</span> <span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_localtime</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tm</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="cm">/* Update internal database according to current TZ setting.
     POSIX.1 8.3.7.2 says that localtime_r is not required to set tzname.
     This is a good idea since this allows at least a bit more parallelism.  */</span>
  <span class="n">tzset_internal</span> <span class="p">(</span><span class="n">tp</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">_tmbuf</span> <span class="o">&amp;&amp;</span> <span class="n">use_localtime</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="cm">/* Interpret the TZ envariable.  */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tzset_internal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">always</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="cm">/* Try to read a data file.  */</span>
  <span class="n">__tzfile_read</span> <span class="p">(</span><span class="n">tz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <details> <summary>/time/tzfile.c:__tzfile_read</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">__tzfile_read</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">extra</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">extrap</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="cm">/* Note the file is opened with cancellation in the I/O functions
     disabled and if available FD_CLOEXEC set.  */</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">"rce"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">ret_free_transitions</span><span class="p">;</span>
<span class="p">...</span>
 <span class="nl">read_again:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">__fread_unlocked</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tzhead</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tzhead</span><span class="p">),</span>
					  <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="o">||</span> <span class="n">memcmp</span> <span class="p">(</span><span class="n">tzhead</span><span class="p">.</span><span class="n">tzh_magic</span><span class="p">,</span> <span class="n">TZ_MAGIC</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tzhead</span><span class="p">.</span><span class="n">tzh_magic</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">lose</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <p>ìœ„ì™€ ê°™ì€ íë¦„ì— ì˜í•´ì„œ <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ê°€ í™ ë©”ëª¨ë¦¬ì— ìƒì„±ë©ë‹ˆë‹¤.</p> <p>ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ íŠ¹ì • í™ ì²­í¬ë¥¼ ê²¹ì¹˜ê²Œ ë§Œë“  í›„ ì´ë¥¼ ë®ì–´ì“°ëŠ” ê³¼ì •ìœ¼ë¡œ ê³µê²©ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p> <p>ë³´ê³ ì„œì— ë‚˜ì˜¨ ë‚´ìš©ì— ë”°ë¥´ë©´ í™ ì†ìƒì„ í†µí•´ <code class="language-plaintext highlighter-rouge">__tzfile_read()</code>ì—ì„œ í• ë‹¹ëœ <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ì˜ <code class="language-plaintext highlighter-rouge">_vtable_offset</code> í•„ë“œ ë®ì–´ì¨ í•¨ìˆ˜ í¬ì¸í„°ì— ì˜í•´ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ë¥¼ ì„ì˜ë¡œ ì¡°ì‘í•˜ì—¬ ì›í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œë©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* The tag name of this struct is _IO_FILE to preserve historic
   C++ mangled names for functions taking FILE* arguments.
   That name should not be used in new code.  */</span>
<span class="k">struct</span> <span class="n">_IO_FILE</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div> <p>ì´ë ‡ê²Œ ì˜¤ì—¼ëœ ë©”íƒ€ë°ì´í„°ëŠ” ìœ„ ì½”ë“œì—ì„œ ì‚´í´ë³¸ <code class="language-plaintext highlighter-rouge">__tzfile_read</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">__fread_unlocked</code>ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì—ì„œ ì›í•˜ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë§Œë“­ë‹ˆë‹¤.</p> <p><code class="language-plaintext highlighter-rouge">__fread_unlocked</code> í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜¸ì¶œ íë¦„ì„ ê°–ìŠµë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/call_graph2.png" /></p> <details> <summary>libio/iofread_u.c:_IO_jump_t</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_jump_t</span>
<span class="p">{</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy2</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_finish_t</span><span class="p">,</span> <span class="n">__finish</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">,</span> <span class="n">__overflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__underflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__uflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">,</span> <span class="n">__pbackfail</span><span class="p">);</span>
    <span class="cm">/* showmany */</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsputn_t</span><span class="p">,</span> <span class="n">__xsputn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsgetn_t</span><span class="p">,</span> <span class="n">__xsgetn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekoff_t</span><span class="p">,</span> <span class="n">__seekoff</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekpos_t</span><span class="p">,</span> <span class="n">__seekpos</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_setbuf_t</span><span class="p">,</span> <span class="n">__setbuf</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">,</span> <span class="n">__sync</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_doallocate_t</span><span class="p">,</span> <span class="n">__doallocate</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_read_t</span><span class="p">,</span> <span class="n">__read</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_write_t</span><span class="p">,</span> <span class="n">__write</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seek_t</span><span class="p">,</span> <span class="n">__seek</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_close_t</span><span class="p">,</span> <span class="n">__close</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_stat_t</span><span class="p">,</span> <span class="n">__stat</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_showmanyc_t</span><span class="p">,</span> <span class="n">__showmanyc</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_imbue_t</span><span class="p">,</span> <span class="n">__imbue</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/iofread_u.c:__fread_unlocked</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span>
<span class="nf">__fread_unlocked</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">bytes_requested</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">bytes_read</span><span class="p">;</span>
  <span class="n">CHECK_FILE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bytes_requested</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">bytes_read</span> <span class="o">=</span> <span class="n">_IO_sgetn</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes_requested</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">bytes_requested</span> <span class="o">==</span> <span class="n">bytes_read</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">bytes_read</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/genops.c:_IO_sgetn</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span>
<span class="nf">_IO_sgetn</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* FIXME handle putback buffer here! */</span>
  <span class="k">return</span> <span class="n">_IO_XSGETN</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_sgetn</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/libioP.h:_IO_XSGETN(FP, DATA, N), _IO_WXSGETN(FP, DATA, N)</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* The 'xsgetn' hook reads upto N characters into buffer DATA.
   Returns the number of character actually read.
   It matches the streambuf::xsgetn virtual function. */</span>
<span class="k">typedef</span> <span class="nf">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">_IO_xsgetn_t</span><span class="p">)</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">FP</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">DATA</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">N</span><span class="p">);</span>
<span class="cp">#define _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)
#define _IO_WXSGETN(FP, DATA, N) WJUMP2 (__xsgetn, FP, DATA, N)
</span></code></pre></div> </div> </div> </details> <details> <summary>libio/fileops.c:_IO_file_xsgetn</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span>
<span class="nf">_IO_file_xsgetn</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">want</span><span class="p">,</span> <span class="n">have</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

  <span class="n">want</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Maybe we already have a push back pointer.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">free</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_IN_BACKUP</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">_IO_doallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">want</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">have</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">want</span> <span class="o">&lt;=</span> <span class="n">have</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">memcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">want</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">want</span><span class="p">;</span>
	  <span class="n">want</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">have</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">s</span> <span class="o">=</span> <span class="n">__mempcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">have</span><span class="p">);</span>
	      <span class="n">want</span> <span class="o">-=</span> <span class="n">have</span><span class="p">;</span>
	      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">have</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="cm">/* Check for backup and repeat */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_in_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">_IO_switch_to_main_get_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	      <span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="cm">/* If we now want less than a buffer, underflow and repeat
	     the copy.  Otherwise, _IO_SYSREAD directly to
	     the user buffer. */</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span>
	      <span class="o">&amp;&amp;</span> <span class="n">want</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">__underflow</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="cm">/* These must be set before the sysread as we might longjmp out
	     waiting for input. */</span>
	  <span class="n">_IO_setg</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>
	  <span class="n">_IO_setp</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>

	  <span class="cm">/* Try to maintain alignment: read a whole number of blocks.  */</span>
	  <span class="n">count</span> <span class="o">=</span> <span class="n">want</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">size_t</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">want</span> <span class="o">%</span> <span class="n">block_size</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSREAD</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_EOF_SEEN</span><span class="p">;</span>
	      <span class="k">else</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>

	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="n">s</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	  <span class="n">want</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">!=</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
	    <span class="n">_IO_pos_adjust</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">want</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_file_xsgetn</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/genops.c</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">__underflow</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_in_put_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_IO_switch_to_get_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_in_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">_IO_switch_to_main_get_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_have_markers</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">save_for_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_IO_have_backup</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="n">_IO_free_backup_area</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">_IO_UNDERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">__underflow</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/libioP.h:_IO_UNDERFLOW(FP),_IO_WUNDERFLOW(FP)</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* The 'underflow' hook tries to fills the get buffer.
   It returns the next character (as an unsigned char) or EOF.  The next
   character remains in the get buffer, and the get position is not changed.
   It matches the streambuf::underflow virtual function. */</span>
<span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">_IO_underflow_t</span><span class="p">)</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#define _IO_UNDERFLOW(FP) JUMP0 (__underflow, FP)
#define _IO_WUNDERFLOW(FP) WJUMP0 (__underflow, FP)
</span></code></pre></div> </div> </div> </details> <p>ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">_vtable_offset</code>ë©¤ë²„ë¥¼ ë®ì–´ ì˜¤í”„ì…‹ì— ì˜í•´ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ë¥¼ <code class="language-plaintext highlighter-rouge">_IO_file_underflow</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">_IO_wfile_underflow</code>ë¥¼ í˜¸ì¶œí•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/call_graph3.png" /></p> <details> <summary>libio/fileops.c:_IO_file_jumps</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="n">_IO_file_jumps</span> <span class="n">libio_vtable</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">JUMP_INIT_DUMMY</span><span class="p">,</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="n">_IO_file_finish</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">overflow</span><span class="p">,</span> <span class="n">_IO_file_overflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">underflow</span><span class="p">,</span> <span class="n">_IO_file_underflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">uflow</span><span class="p">,</span> <span class="n">_IO_default_uflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">pbackfail</span><span class="p">,</span> <span class="n">_IO_default_pbackfail</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">xsputn</span><span class="p">,</span> <span class="n">_IO_file_xsputn</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">xsgetn</span><span class="p">,</span> <span class="n">_IO_file_xsgetn</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seekoff</span><span class="p">,</span> <span class="n">_IO_new_file_seekoff</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seekpos</span><span class="p">,</span> <span class="n">_IO_default_seekpos</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">setbuf</span><span class="p">,</span> <span class="n">_IO_new_file_setbuf</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="n">_IO_new_file_sync</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">doallocate</span><span class="p">,</span> <span class="n">_IO_file_doallocate</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">_IO_file_read</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">_IO_new_file_write</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seek</span><span class="p">,</span> <span class="n">_IO_file_seek</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">_IO_file_close</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">_IO_file_stat</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">showmanyc</span><span class="p">,</span> <span class="n">_IO_default_showmanyc</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">imbue</span><span class="p">,</span> <span class="n">_IO_default_imbue</span><span class="p">)</span>
<span class="p">};</span>
<span class="n">libc_hidden_data_def</span> <span class="p">(</span><span class="n">_IO_file_jumps</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/wfileops.c:_IO_wfile_jumps</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="n">_IO_wfile_jumps</span> <span class="n">libio_vtable</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">JUMP_INIT_DUMMY</span><span class="p">,</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span> <span class="n">_IO_new_file_finish</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">overflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">)</span> <span class="n">_IO_wfile_overflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">underflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">)</span> <span class="n">_IO_wfile_underflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">uflow</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">)</span> <span class="n">_IO_wdefault_uflow</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">pbackfail</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">)</span> <span class="n">_IO_wdefault_pbackfail</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">xsputn</span><span class="p">,</span> <span class="n">_IO_wfile_xsputn</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">xsgetn</span><span class="p">,</span> <span class="n">_IO_file_xsgetn</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seekoff</span><span class="p">,</span> <span class="n">_IO_wfile_seekoff</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seekpos</span><span class="p">,</span> <span class="n">_IO_default_seekpos</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">setbuf</span><span class="p">,</span> <span class="n">_IO_new_file_setbuf</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">)</span> <span class="n">_IO_wfile_sync</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">doallocate</span><span class="p">,</span> <span class="n">_IO_wfile_doallocate</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">_IO_file_read</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">_IO_new_file_write</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">seek</span><span class="p">,</span> <span class="n">_IO_file_seek</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">_IO_file_close</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">_IO_file_stat</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">showmanyc</span><span class="p">,</span> <span class="n">_IO_default_showmanyc</span><span class="p">),</span>
  <span class="n">JUMP_INIT</span><span class="p">(</span><span class="n">imbue</span><span class="p">,</span> <span class="n">_IO_default_imbue</span><span class="p">)</span>
<span class="p">};</span>
<span class="n">libc_hidden_data_def</span> <span class="p">(</span><span class="n">_IO_wfile_jumps</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/fileops.c:_IO_new_file_underflow</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">_IO_new_file_underflow</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

  <span class="cm">/* C99 requires EOF to be "sticky".  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_EOF_SEEN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_READS</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Maybe we already have a push back pointer.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">free</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_IN_BACKUP</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">_IO_doallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* FIXME This can/should be moved to genops ?? */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IO_LINE_BUF</span><span class="o">|</span><span class="n">_IO_UNBUFFERED</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* We used to flush all line-buffered stream.  This really isn't
	 required by any standard.  My recollection is that
	 traditional Unix systems did this for stdout.  stderr better
	 not be line buffered.  So we do just that here
	 explicitly.  --drepper */</span>
      <span class="n">_IO_acquire_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">stdout</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IO_LINKED</span> <span class="o">|</span> <span class="n">_IO_NO_WRITES</span> <span class="o">|</span> <span class="n">_IO_LINE_BUF</span><span class="p">))</span>
	  <span class="o">==</span> <span class="p">(</span><span class="n">_IO_LINKED</span> <span class="o">|</span> <span class="n">_IO_LINE_BUF</span><span class="p">))</span>
	<span class="n">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">EOF</span><span class="p">);</span>

      <span class="n">_IO_release_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">_IO_switch_to_get_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="cm">/* This is very tricky. We have to adjust those
     pointers before we call _IO_SYSREAD () since
     we may longjump () out while waiting for
     input. Those pointers may be screwed up. H.J. */</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span>
    <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>

  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSREAD</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span>
		       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_EOF_SEEN</span><span class="p">;</span>
      <span class="k">else</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* If a stream is read to EOF, the calling application may switch active
	 handles.  As a result, our offset cache would no longer be valid, so
	 unset it.  */</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">!=</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
    <span class="n">_IO_pos_adjust</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">libc_hidden_ver</span> <span class="p">(</span><span class="n">_IO_new_file_underflow</span><span class="p">,</span> <span class="n">_IO_file_underflow</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/wfileops.c:_IO_wfile_underflow</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">wint_t</span>
<span class="nf">_IO_wfile_underflow</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">cd</span><span class="p">;</span>
  <span class="k">enum</span> <span class="n">__codecvt_result</span> <span class="n">status</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

  <span class="cm">/* C99 requires EOF to be "sticky".  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_EOF_SEEN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_READS</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>

  <span class="n">cd</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_codecvt</span><span class="p">;</span>

  <span class="cm">/* Maybe there is something left in the external buffer.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* There is more in the external.  Convert it.  */</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">read_stop</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>

      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_last_state</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_state</span><span class="p">;</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">__libio_codecvt_in</span> <span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_state</span><span class="p">,</span>
				   <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">read_stop</span><span class="p">,</span>
				   <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span>
				   <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">);</span>

      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">read_stop</span><span class="p">;</span>

      <span class="cm">/* If we managed to generate some text return the next character.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">__codecvt_error</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EILSEQ</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
	  <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="cm">/* Move the remaining content of the read buffer to the beginning.  */</span>
      <span class="n">memmove</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span>
	       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">);</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span>
			  <span class="o">+</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">));</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Maybe we already have a push back pointer.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">free</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_IN_BACKUP</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">_IO_doallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>

      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">=</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Maybe we already have a push back pointer.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">free</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_IN_BACKUP</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">_IO_wdoallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/* FIXME This can/should be moved to genops ?? */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IO_LINE_BUF</span> <span class="o">|</span> <span class="n">_IO_UNBUFFERED</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* We used to flush all line-buffered stream.  This really isn't
	 required by any standard.  My recollection is that
	 traditional Unix systems did this for stdout.  stderr better
	 not be line buffered.  So we do just that here
	 explicitly.  --drepper */</span>
      <span class="n">_IO_acquire_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">stdout</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_IO_LINKED</span> <span class="o">|</span> <span class="n">_IO_NO_WRITES</span> <span class="o">|</span> <span class="n">_IO_LINE_BUF</span><span class="p">))</span>
	  <span class="o">==</span> <span class="p">(</span><span class="n">_IO_LINKED</span> <span class="o">|</span> <span class="n">_IO_LINE_BUF</span><span class="p">))</span>
	<span class="n">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">EOF</span><span class="p">);</span>

      <span class="n">_IO_release_lock</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">_IO_switch_to_get_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">=</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">;</span>

  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">read_ptr_copy</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">accbuf</span><span class="p">[</span><span class="n">MB_LEN_MAX</span><span class="p">];</span>
  <span class="kt">size_t</span> <span class="n">naccbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">again:</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSREAD</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span>
		       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">naccbuf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_EOF_SEEN</span><span class="p">;</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="cm">/* There are some bytes in the external buffer but they don't
	   convert to anything.  */</span>
	<span class="n">__set_errno</span> <span class="p">(</span><span class="n">EILSEQ</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">!=</span> <span class="n">_IO_pos_BAD</span><span class="p">)</span>
    <span class="n">_IO_pos_adjust</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

  <span class="cm">/* Now convert the read input.  */</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_last_state</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_state</span><span class="p">;</span>
  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">to_copy</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">to_copy</span> <span class="o">=</span> <span class="n">MIN</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">accbuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">naccbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
      <span class="n">to</span> <span class="o">=</span> <span class="n">__mempcpy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">accbuf</span><span class="p">[</span><span class="n">naccbuf</span><span class="p">],</span> <span class="n">from</span><span class="p">,</span> <span class="n">to_copy</span><span class="p">);</span>
      <span class="n">naccbuf</span> <span class="o">+=</span> <span class="n">to_copy</span><span class="p">;</span>
      <span class="n">from</span> <span class="o">=</span> <span class="n">accbuf</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">__libio_codecvt_in</span> <span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_state</span><span class="p">,</span>
			       <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_ptr_copy</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_end</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">MAX</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">read_ptr_copy</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">accbuf</span><span class="p">[</span><span class="n">naccbuf</span> <span class="o">-</span> <span class="n">to_copy</span><span class="p">]);</span>
  <span class="k">else</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">read_ptr_copy</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">==</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">__codecvt_error</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">out_eilseq:</span>
	  <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EILSEQ</span><span class="p">);</span>
	  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
	  <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="cm">/* The read bytes make no complete character.  Try reading again.  */</span>
      <span class="n">assert</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">__codecvt_partial</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* Partially used the buffer for some input data that
		 produces no output.  */</span>
	      <span class="kt">size_t</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
	      <span class="n">memmove</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">avail</span><span class="p">);</span>
	      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span><span class="p">;</span>
	      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-=</span> <span class="n">avail</span><span class="p">;</span>
	      <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">naccbuf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">accbuf</span><span class="p">))</span>
	    <span class="k">goto</span> <span class="n">out_eilseq</span><span class="p">;</span>

	  <span class="n">memcpy</span> <span class="p">(</span><span class="n">accbuf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">naccbuf</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="kt">size_t</span> <span class="n">used</span> <span class="o">=</span> <span class="n">read_ptr_copy</span> <span class="o">-</span> <span class="n">accbuf</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">memmove</span> <span class="p">(</span><span class="n">accbuf</span><span class="p">,</span> <span class="n">read_ptr_copy</span><span class="p">,</span> <span class="n">naccbuf</span> <span class="o">-</span> <span class="n">used</span><span class="p">);</span>
	      <span class="n">naccbuf</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>
	    <span class="p">}</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">naccbuf</span> <span class="o">==</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">accbuf</span><span class="p">))</span>
	    <span class="k">goto</span> <span class="n">out_eilseq</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span><span class="p">;</span>

      <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_wfile_underflow</span><span class="p">)</span>
</code></pre></div> </div> </div> </details> <p><code class="language-plaintext highlighter-rouge">_IO_wfile_underflow</code>ëŠ” ë‹¤ìŒ íë¦„ì„ ê°–ëŠ”ë° ì´ë•Œ <code class="language-plaintext highlighter-rouge">__fct</code> í•¨ìˆ˜ í¬ì¸í„°ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì›í•˜ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/call_graph4.png" /></p> <details> <summary>libio/iofwide.c</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">__codecvt_result</span>
<span class="nf">__libio_codecvt_in</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">codecvt</span><span class="p">,</span> <span class="n">__mbstate_t</span> <span class="o">*</span><span class="n">statep</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from_start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from_end</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">from_stop</span><span class="p">,</span>
		    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">to_start</span><span class="p">,</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">to_end</span><span class="p">,</span> <span class="kt">wchar_t</span> <span class="o">**</span><span class="n">to_stop</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">enum</span> <span class="n">__codecvt_result</span> <span class="n">result</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">__gconv_step</span> <span class="o">*</span><span class="n">gs</span> <span class="o">=</span> <span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">dummy</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from_start_copy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">from_start</span><span class="p">;</span>

  <span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step_data</span><span class="p">.</span><span class="n">__outbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">to_start</span><span class="p">;</span>
  <span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step_data</span><span class="p">.</span><span class="n">__outbufend</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">to_end</span><span class="p">;</span>
  <span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step_data</span><span class="p">.</span><span class="n">__statep</span> <span class="o">=</span> <span class="n">statep</span><span class="p">;</span>

  <span class="n">__gconv_fct</span> <span class="n">fct</span> <span class="o">=</span> <span class="n">gs</span><span class="o">-&gt;</span><span class="n">__fct</span><span class="p">;</span>
<span class="cp">#ifdef PTR_DEMANGLE
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">gs</span><span class="o">-&gt;</span><span class="n">__shlib_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">PTR_DEMANGLE</span> <span class="p">(</span><span class="n">fct</span><span class="p">);</span>
<span class="cp">#endif
</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">DL_CALL_FCT</span> <span class="p">(</span><span class="n">fct</span><span class="p">,</span>
			<span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from_start_copy</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">from_end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

  <span class="o">*</span><span class="n">from_stop</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">from_start_copy</span><span class="p">;</span>
  <span class="o">*</span><span class="n">to_stop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">codecvt</span><span class="o">-&gt;</span><span class="n">__cd_in</span><span class="p">.</span><span class="n">step_data</span><span class="p">.</span><span class="n">__outbuf</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">__GCONV_OK</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">__GCONV_EMPTY_INPUT</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">__codecvt_ok</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">__GCONV_FULL_OUTPUT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">__GCONV_INCOMPLETE_INPUT</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">__codecvt_partial</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">__codecvt_error</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <p>ì—¬ê¸°ì—ì„œ í•¨ìˆ˜ í¬ì¸í„°ë¡œ ì°¸ì¡°ë˜ëŠ” ë©¤ë²„ì˜ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ê²Œë©ë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/structure_graph.png" /></p> <details> <summary>libio/libioP.h</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_jump_t</span>
<span class="p">{</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy2</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_finish_t</span><span class="p">,</span> <span class="n">__finish</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">,</span> <span class="n">__overflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__underflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__uflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">,</span> <span class="n">__pbackfail</span><span class="p">);</span>
    <span class="cm">/* showmany */</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsputn_t</span><span class="p">,</span> <span class="n">__xsputn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsgetn_t</span><span class="p">,</span> <span class="n">__xsgetn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekoff_t</span><span class="p">,</span> <span class="n">__seekoff</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekpos_t</span><span class="p">,</span> <span class="n">__seekpos</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_setbuf_t</span><span class="p">,</span> <span class="n">__setbuf</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">,</span> <span class="n">__sync</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_doallocate_t</span><span class="p">,</span> <span class="n">__doallocate</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_read_t</span><span class="p">,</span> <span class="n">__read</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_write_t</span><span class="p">,</span> <span class="n">__write</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seek_t</span><span class="p">,</span> <span class="n">__seek</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_close_t</span><span class="p">,</span> <span class="n">__close</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_stat_t</span><span class="p">,</span> <span class="n">__stat</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_showmanyc_t</span><span class="p">,</span> <span class="n">__showmanyc</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_imbue_t</span><span class="p">,</span> <span class="n">__imbue</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* We always allocate an extra word following an _IO_FILE.
   This contains a pointer to the function jump table used.
   This is for compatibility with C++ streambuf; the word can
   be used to smash to a pointer to a virtual function table. */</span>

<span class="k">struct</span> <span class="n">_IO_FILE_plus</span>
<span class="p">{</span>
  <span class="kt">FILE</span> <span class="n">file</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio/bits/types/struct_FILE.h:struct _IO_FILE</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* The tag name of this struct is _IO_FILE to preserve historic
   C++ mangled names for functions taking FILE* arguments.
   That name should not be used in new code.  */</span>
<span class="k">struct</span> <span class="n">_IO_FILE</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">_flags</span><span class="p">;</span>		<span class="cm">/* High-order word is _IO_MAGIC; rest is flags. */</span>

  <span class="cm">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>	<span class="cm">/* Current read pointer */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>	<span class="cm">/* End of get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span>	<span class="cm">/* Start of putback+get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span>	<span class="cm">/* Start of put area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span>	<span class="cm">/* Current put pointer. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span>	<span class="cm">/* End of put area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>	<span class="cm">/* Start of reserve area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>	<span class="cm">/* End of reserve area. */</span>

  <span class="cm">/* The following fields are used to support backing up and undo. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span> <span class="cm">/* Pointer to start of non-current get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>  <span class="cm">/* Pointer to first valid character of backup area */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span> <span class="cm">/* Pointer to end of non-current get area. */</span>

  <span class="k">struct</span> <span class="n">_IO_marker</span> <span class="o">*</span><span class="n">_markers</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_chain</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">_fileno</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_flags2</span><span class="p">;</span>
  <span class="n">__off_t</span> <span class="n">_old_offset</span><span class="p">;</span> <span class="cm">/* This used to be _offset but it's too small.  */</span>

  <span class="cm">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_cur_column</span><span class="p">;</span>
  <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="n">_IO_lock_t</span> <span class="o">*</span><span class="n">_lock</span><span class="p">;</span>
<span class="cp">#ifdef _IO_USE_OLD_IO_FILE
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">_IO_FILE_complete</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="n">_file</span><span class="p">;</span>
<span class="cp">#endif
</span>  <span class="n">__off64_t</span> <span class="n">_offset</span><span class="p">;</span>
  <span class="cm">/* Wide character stream stuff.  */</span>
  <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">_codecvt</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_wide_data</span> <span class="o">*</span><span class="n">_wide_data</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_freeres_list</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">_freeres_buf</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">__pad5</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_mode</span><span class="p">;</span>
  <span class="cm">/* Make sure we don't get into trouble again.  */</span>
  <span class="kt">char</span> <span class="n">_unused2</span><span class="p">[</span><span class="mi">15</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)];</span>
<span class="p">};</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio.h:_IO_codecvt</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_codecvt</span>
<span class="p">{</span>
  <span class="n">_IO_iconv_t</span> <span class="n">__cd_in</span><span class="p">;</span>
  <span class="n">_IO_iconv_t</span> <span class="n">__cd_out</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div> </div> </div> </details> <details> <summary>libio.h:_IO_iconv_t</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">__gconv_step</span> <span class="o">*</span><span class="n">step</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">__gconv_step_data</span> <span class="n">step_data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">_IO_iconv_t</span><span class="p">;</span>
</code></pre></div> </div> </div> </details> <details> <summary>gconv.h:__gconv_step</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Description of a conversion step.  */</span>
<span class="k">struct</span> <span class="n">__gconv_step</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">__gconv_loaded_object</span> <span class="o">*</span><span class="n">__shlib_handle</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__modname</span><span class="p">;</span>

  <span class="cm">/* For internal use by glibc.  (Accesses to this member must occur
     when the internal __gconv_lock mutex is acquired).  */</span>
  <span class="kt">int</span> <span class="n">__counter</span><span class="p">;</span>

  <span class="kt">char</span> <span class="o">*</span><span class="n">__from_name</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">__to_name</span><span class="p">;</span>

  <span class="n">__gconv_fct</span> <span class="n">__fct</span><span class="p">;</span>
  <span class="n">__gconv_btowc_fct</span> <span class="n">__btowc_fct</span><span class="p">;</span>
  <span class="n">__gconv_init_fct</span> <span class="n">__init_fct</span><span class="p">;</span>
  <span class="n">__gconv_end_fct</span> <span class="n">__end_fct</span><span class="p">;</span>

  <span class="cm">/* Information about the number of bytes needed or produced in this
     step.  This helps optimizing the buffer sizes.  */</span>
  <span class="kt">int</span> <span class="n">__min_needed_from</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">__max_needed_from</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">__min_needed_to</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">__max_needed_to</span><span class="p">;</span>

  <span class="cm">/* Flag whether this is a stateful encoding or not.  */</span>
  <span class="kt">int</span> <span class="n">__stateful</span><span class="p">;</span>

  <span class="kt">void</span> <span class="o">*</span><span class="n">__data</span><span class="p">;</span>		<span class="cm">/* Pointer to step-local data.  */</span>
<span class="p">};</span>
</code></pre></div> </div> </div> </details> <details> <summary>iconv/gconv.h:__gconv_fct</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Type of a conversion function.  */</span>
<span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__gconv_fct</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">__gconv_step</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__gconv_step_data</span> <span class="o">*</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</code></pre></div> </div> </div> </details> <h4 id="exploit-strategy"> <a href="#exploit-strategy" class="anchor-head"></a> Exploit strategy </h4> <p><code class="language-plaintext highlighter-rouge">SIGALRM</code>ì— ì˜í•´ì„œ ì–´ë–»ê²Œ <code class="language-plaintext highlighter-rouge">Exploit</code>ì„ ë‹¬ì„±í•˜ëŠ”ì§€ ì•Œì•„ë´…ì‹œë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1449</span> <span class="err">#</span><span class="n">define</span> <span class="nf">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>       <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mchunk_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="o">------------------------------------------------------------------------</span>
<span class="mi">3765</span> <span class="n">_int_malloc</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">)</span>
<span class="mi">3766</span> <span class="p">{</span>
<span class="p">....</span>
<span class="mi">3798</span>   <span class="n">nb</span> <span class="o">=</span> <span class="n">checked_request2size</span> <span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
<span class="p">....</span>
<span class="mi">4295</span>               <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="p">....</span>
<span class="mi">4300</span>               <span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
<span class="p">....</span>
<span class="mi">4316</span>                   <span class="n">remainder</span> <span class="o">=</span> <span class="n">chunk_at_offset</span> <span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="p">....</span>
<span class="mi">4320</span>                   <span class="n">bck</span> <span class="o">=</span> <span class="n">unsorted_chunks</span> <span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="mi">4321</span>                   <span class="n">fwd</span> <span class="o">=</span> <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="p">....</span>
<span class="mi">4324</span>                   <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">bck</span><span class="p">;</span>
<span class="mi">4325</span>                   <span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
<span class="mi">4326</span>                   <span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
<span class="mi">4327</span>                   <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>
<span class="p">....</span>
<span class="mi">4337</span>                   <span class="nf">set_head</span> <span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span> <span class="o">|</span> <span class="n">PREV_INUSE</span> <span class="o">|</span>
<span class="mi">4338</span>                             <span class="p">(</span><span class="n">av</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">main_arena</span> <span class="o">?</span> <span class="n">NON_MAIN_ARENA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="mi">4339</span>                   <span class="nf">set_head</span> <span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="p">....</span>
<span class="mi">4343</span>               <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="p">....</span>
<span class="mi">4345</span>               <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">malloc</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">4327</code>í–‰ì´ ì‹¤í–‰ëœ ì´í›„ì— <code class="language-plaintext highlighter-rouge">4339</code>í–‰ ì´ì „ì´ ì‹¤í–‰ë˜ê¸°ì „ <code class="language-plaintext highlighter-rouge">SIGALRM</code>ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">malloc</code>ì´ ì¤‘ë‹¨ë˜ëŠ” ê²½ìš°ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.</p> <p>ê·¸ë ‡ê²Œë˜ë©´ <code class="language-plaintext highlighter-rouge">remainder</code>ê°€ ìª¼ê°œì¡Œì§€ë§Œ í¬ê¸°ëŠ” ê°±ì‹ ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ <code class="language-plaintext highlighter-rouge">unsorted</code> ë¦¬ìŠ¤íŠ¸ì— ì—°ê²°ë˜ê²Œ ë©ë‹ˆë‹¤. ì´ë•Œì˜ í¬ê¸° í•„ë“œê°’ì€ ê°±ì‹ ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì´ì „ì— ì´ ì²­í¬ë¥¼ í• ë‹¹ë°›ì€ ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆì–´ í•´ë‹¹ ê°’ì´ í¬ê¸° ë°ì´í„°ë¡œ ì‚¬ìš©ë˜ê²Œ ë©ë‹ˆë‹¤. ì´ë ‡ê²Œí•˜ì—¬ ì»¤ì§„ <code class="language-plaintext highlighter-rouge">remainder chunk</code>ì˜ í¬ê¸°ëŠ” ë’·ìª½ì„ ë®ì–´ì“¸ ìˆ˜ ìˆì„ë§Œí¼ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p> <p>ì´ë¥¼ ì•…ìš©í•˜ëŠ” íë¦„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/exploit_process.png" /></p> <ul> <li><code class="language-plaintext highlighter-rouge">Large hole</code>(8KB í¬ê¸°ì˜ freeëœ ì²­í¬)ì™€ <code class="language-plaintext highlighter-rouge">small hole</code>(<code class="language-plaintext highlighter-rouge">320B</code> í¬ê¸°ì˜ <code class="language-plaintext highlighter-rouge">free</code>ëœ ì²­í¬)ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.</li> <li><code class="language-plaintext highlighter-rouge">4KB</code> í¬ê¸°ì˜ ì²­í¬ë¥¼ ìš”ì²­í•˜ì—¬ <code class="language-plaintext highlighter-rouge">Large hole</code>ì„ ë‘ ê°œì˜ ì²­í¬ë¡œ ë‚˜ëˆ„ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤. <ul> <li>ì´ë•Œ í•´ë‹¹ ì‘ì—…ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">Large hole</code>ì´ ë‘ ê°œì˜ ì²­í¬ë¡œ ë‚˜ë‰˜ì–´ì§„ ë’¤ ìœ„ì˜ <code class="language-plaintext highlighter-rouge">4339</code>í–‰ì´ ì‹¤í–‰ë˜ê¸°ì „ì— <code class="language-plaintext highlighter-rouge">SIGALRM</code>ì— ì˜í•´ì„œ <code class="language-plaintext highlighter-rouge">malloc</code>ì˜ ì²˜ë¦¬ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.</li> <li>ì´ë ‡ê²Œ ì²˜ë¦¬ê°€ ì¤‘ë‹¨ëœ <code class="language-plaintext highlighter-rouge">free remainder</code> ì²­í¬ì˜ í¬ê¸°ëŠ” ì´ì „ ê°’ì— ì˜í•´ì„œ ê²°ì •ë©ë‹ˆë‹¤.</li> <li><code class="language-plaintext highlighter-rouge">remainder</code>ì˜ í¬ê¸°ê°€ ê°±ì‹ ë˜ì§€ ì•Šê³  ì´ì „ ê°’(ì°Œê±°ê¸° ê°’)ì— ì˜í•´ì„œ í¬ê¸°ê°€ ì¦ê°€í–ˆê¸° ë•Œë¬¸ì— ì²­í¬ëŠ” ë’¤ì˜ <code class="language-plaintext highlighter-rouge">small hole</code>ê¹Œì§€ ê²¹ì¹˜ê²Œë©ë‹ˆë‹¤.</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">SIGARLM</code>ì˜ <code class="language-plaintext highlighter-rouge">syslog</code>ì—ì„œ ì•ì„œ ì•Œì•„ë³¸ íë¦„ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">fopen</code>ì„ í˜¸ì¶œí•´ <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ê°€ <code class="language-plaintext highlighter-rouge">small hole</code>ì— í• ë‹¹ë©ë‹ˆë‹¤. <ul> <li>ì´ëŠ” ì•ì„  ì²˜ë¦¬ì— ì˜í•´ <code class="language-plaintext highlighter-rouge">remainder</code> ì²­í¬ì™€ ê²¹ì¹˜ëŠ” ì˜ì—­ì´ ë©ë‹ˆë‹¤.</li> </ul> </li> <li>ì¸ìœ„ì ìœ¼ë¡œ ì¦ê°€í•œ <code class="language-plaintext highlighter-rouge">remainder</code> ì²­í¬ëŠ” <code class="language-plaintext highlighter-rouge">fopen</code> ì´í›„ì˜ <code class="language-plaintext highlighter-rouge">__fread_unlocked</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">4KB read buffer</code>ë¥¼ í• ë‹¹ë°›ëŠ” ê³¼ì •ì—ì„œ í•œë²ˆ ë” ìª¼ê°œì§€ê²Œë©ë‹ˆë‹¤.</li> <li>remainder ì²­í¬ê°€ ê¸°ë¡ë˜ê³  FILEì˜ <code class="language-plaintext highlighter-rouge">_vtable_offset</code> ë©¤ë²„ê°€ remainder ì²­í¬ì˜ bk í•„ë“œì˜ 3ë²ˆì§¸ ë°”ì´íŠ¸ë¡œ ë®ì–´ì”Œì›Œì§€ê²Œë©ë‹ˆë‹¤.(0x61) <ul> <li>ì´ë•Œ <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ì˜ <code class="language-plaintext highlighter-rouge">_codevt</code> ë©¤ë²„ëŠ” <code class="language-plaintext highlighter-rouge">glibc</code>ì˜ <code class="language-plaintext highlighter-rouge">malloc</code> ë¹ˆ ì¤‘ í•˜ë‚˜ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</li> <li>ì´ë•Œì˜ ê°€ì •ì€ í•´ë‹¹ ì£¼ì†Œë¥¼ ëª¨ë‘ ê³µê²©ìê°€ ì•ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.</li> </ul> </li> </ul> <p>ìœ„ì˜ ì„¤ëª…ë§Œ ë´ë„ ì—„ì²­ë‚˜ê²Œ ê¹Œë‹¤ë¡œìš´ ì¡°ê±´ì´ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ê¹Œë‹¤ë¡œìš´ ì¡°ê±´ë“¤ì„ ë‹¤ì‹œ ì •ë¦¬í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p> <ul> <li>ê³µê²©ì„ ì„±ê³µì‹œí‚¤ê¸° ìœ„í•´ì„  <code class="language-plaintext highlighter-rouge">glibc</code> <code class="language-plaintext highlighter-rouge">FILE</code> êµ¬ì¡°ì²´ì˜ <code class="language-plaintext highlighter-rouge">_vtable_offset</code>ì´ í™œì„±í™” ë˜ì–´ìˆì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í˜„ì¬ ì •ë¦¬ëœ ê¸€ì—ì„  i386 glibcë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li> <li>ë˜í•œ i386 sshdì˜ ë©”ëª¨ë¦¬ê°€ <code class="language-plaintext highlighter-rouge">0xb7200000</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">0xb7400000</code>ì—ë§Œ ë§¤í•‘ëœë‹¤ëŠ” ì ì„ ì•…ìš©í•©ë‹ˆë‹¤. <ul> <li>ì´ë¥¼ ì´ìš©í•´ <code class="language-plaintext highlighter-rouge">ASLR</code>ì„ ìµœëŒ€í•œ ìš°íšŒí•˜ê³  ì´ë¯¸ ì•Œê³  ìˆëŠ” ì£¼ì†Œë¥¼ í™œìš©í•©ë‹ˆë‹¤.</li> </ul> </li> <li>ì•ì„  ì–¸ê¸‰ê³¼ ê°™ì´ ì´ë¯¸ ì£¼ì†Œê°’ë“¤ì„ ì•Œê³  ìˆë‹¤ëŠ” ê°€ì •ìœ¼ë¡œ ì‹œì‘ì„ í•˜ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">_vtable_offset</code>ì„ ë®ì–´ì“¸ ë•Œ ì“°ëŠ” <code class="language-plaintext highlighter-rouge">bk</code>ê°’ ì—­ì‹œ <code class="language-plaintext highlighter-rouge">0xb761d7f8</code>ë¡œ ê³ ì •ì…ë‹ˆë‹¤. <ul> <li>í•´ë‹¹ ê°’ì˜ 3ë²ˆì§¸ ë°”ì´íŠ¸ ê°’ì´ <code class="language-plaintext highlighter-rouge">0x61</code>ì´ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">_vtable_offset</code>ì´ <code class="language-plaintext highlighter-rouge">0x61</code>ë¡œ ì˜¤ì—¼ëœë‹¤ê³  ê°€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">FILE</code>ì„ ë®ì–´ì“°ê¸° ìœ„í•´ ì •í™•í•œ íƒ€ì´ë°ì— ìœ„ ë ˆì´ì•„ì›ƒì„ ë‹¬ì„±í•œ ìƒíƒœë¡œ <code class="language-plaintext highlighter-rouge">malloc</code>ì˜ ìˆ˜í–‰ ì¤‘ì— <code class="language-plaintext highlighter-rouge">SIGALRM</code>ì´ ë°œìƒí•´ì•¼í•©ë‹ˆë‹¤.</li> </ul> <p>ìœ„ì™€ ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ì‹¤í—˜ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë ˆì´ì•„ì›ƒì„ êµ¬ìƒí•˜ì—¬ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì—ì„œ ëª©ì ì„ ë‹¬ì„±í•˜ë ¤í•©ë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/heap_layout.png" /></p> <p>í™ ë ˆì´ì•„ì›ƒì„ ì–´ë–»ê²Œ ì´ë ‡ê²Œ ë§Œë“¤ê¹Œìš”? ë‹¤ìŒ í•¨ìˆ˜ë“¤ì„ ì´ìš©í•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1754</span> <span class="nf">cert_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sshkey</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">certbuf</span><span class="p">)</span>
<span class="mi">1755</span> <span class="p">{</span>
<span class="p">....</span>
<span class="mi">1797</span>         <span class="k">while</span> <span class="p">(</span><span class="n">sshbuf_len</span><span class="p">(</span><span class="n">principals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="p">....</span>
<span class="mi">1805</span>                 <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">sshbuf_get_cstring</span><span class="p">(</span><span class="n">principals</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">principal</span><span class="p">,</span>
<span class="p">....</span>
<span class="mi">1820</span>                 <span class="n">key</span><span class="o">-&gt;</span><span class="n">cert</span><span class="o">-&gt;</span><span class="n">principals</span><span class="p">[</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cert</span><span class="o">-&gt;</span><span class="n">nprincipals</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal</span><span class="p">;</span>
<span class="mi">1821</span>         <span class="p">}</span>
<span class="o">------------------------------------------------------------------------</span>
 <span class="mi">562</span> <span class="n">cert_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">sshkey_cert</span> <span class="o">*</span><span class="n">cert</span><span class="p">)</span>
 <span class="mi">563</span> <span class="p">{</span>
 <span class="p">...</span>
 <span class="mi">572</span>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cert</span><span class="o">-&gt;</span><span class="n">nprincipals</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
 <span class="mi">573</span>                 <span class="n">free</span><span class="p">(</span><span class="n">cert</span><span class="o">-&gt;</span><span class="n">principals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</code></pre></div></div> <p>í•¨ìˆ˜ ëª…ì—ì„œë„ ë³¼ ìˆ˜ ìˆë“¯ ê³µê°œ í‚¤ íŒŒì‹± ì½”ë“œë¥¼ ì•…ìš©í•´ì„œ ìœ„ì˜ í™ ë ˆì´ì•„ì›ƒì„ ë§Œë“¤ê²Œë©ë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">cert_parse</code>ì˜ <code class="language-plaintext highlighter-rouge">1805</code>í–‰ì— ìœ„ì¹˜í•œ <a href="https://github.com/openssh/openssh-portable/blob/V_9_2/sshkey.c#L1805"><code class="language-plaintext highlighter-rouge">sshbuf_get_cstring</code></a>ê³¼ <code class="language-plaintext highlighter-rouge">cert_free</code>ì˜ <code class="language-plaintext highlighter-rouge">573</code>í–‰ì— ìœ„ì¹˜í•œ <a href="https://github.com/openssh/openssh-portable/blob/V_9_2/sshkey.c#L573C3-L573C7"><code class="language-plaintext highlighter-rouge">free</code></a>ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.</p> <p><code class="language-plaintext highlighter-rouge">sshbuf_get_cstring</code>ì€ ë‹¤ìŒê³¼ ê°™ì´ <code class="language-plaintext highlighter-rouge">malloc</code>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">sshbuf_get_cstring</span><span class="p">(</span><span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">valp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">valp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lenp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshbuf_peek_string_direct</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="cm">/* Allow a \0 only at the end of the string */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">p</span> <span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SSHBUF_DBG</span><span class="p">((</span><span class="s">"SSH_ERR_INVALID_FORMAT"</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">SSH_ERR_INVALID_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshbuf_skip_string</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SSHBUF_DBG</span><span class="p">((</span><span class="s">"SSH_ERR_ALLOC_FAIL"</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">SSH_ERR_ALLOC_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">valp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">valp</span><span class="p">)[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lenp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>ìœ„ì—ì„œ ì•Œì•„ë³¸ í™ ë ˆì´ì•„ì›ƒì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">sshd</code>ì— ë‹¤ìŒê³¼ ê°™ì€ 5ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ê³µê°œ í‚¤ íŒ¨í‚·ì„ ì „ì†¡í•©ë‹ˆë‹¤.</p> <ul> <li>a : <code class="language-plaintext highlighter-rouge">tcache</code> í¬ê¸°ì˜ ì²­í¬ë¥¼ <code class="language-plaintext highlighter-rouge">malloc</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">free</code>í•˜ê¸° ìœ„í•œ íŒ¨í‚·</li> <li>b : ë‹¤ì–‘í•œ í¬ê¸°(<code class="language-plaintext highlighter-rouge">~8KB</code>, <code class="language-plaintext highlighter-rouge">320B hole</code>)ì˜ ì²­í¬ë¥¼ <code class="language-plaintext highlighter-rouge">malloc</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">free</code>í•˜ì—¬ 27ê°œì˜ <code class="language-plaintext highlighter-rouge">large hole</code>, <code class="language-plaintext highlighter-rouge">small hole</code> ìŒì„ ë§Œë“¤ê¸° ìœ„í•œ íŒ¨í‚·</li> <li>c : ì´ë¯¸ <code class="language-plaintext highlighter-rouge">free</code>ëœ ì²­í¬ë“¤ì´ ìµìŠ¤í”Œë¡œì‡ì—ì„œ ì¡°ì‘ëœ ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë¯¸ë¦¬ ê°’ë“¤ì„ ì„¸íŒ…í•´ë‘ëŠ” íŒ¨í‚· <ul> <li><code class="language-plaintext highlighter-rouge">remainder</code>ì˜ í¬ê¸°ë¥¼ í¬ê²Œ ë§Œë“¤ ê°€ì§œ í—¤ë”ë¥¼ ì¤‘ê°„ì— ê¸°ë¡</li> <li><code class="language-plaintext highlighter-rouge">glibc</code>ì˜ ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ê¸° ìœ„í•œ <code class="language-plaintext highlighter-rouge">footer</code>ë¥¼ <code class="language-plaintext highlighter-rouge">small hole</code> ë ë¶€ë¶„ì— ê¸°ë¡</li> <li><code class="language-plaintext highlighter-rouge">fake vtable</code>ê³¼ <code class="language-plaintext highlighter-rouge">_codecvt</code> í¬ì¸í„°ë¥¼ <code class="language-plaintext highlighter-rouge">small hole</code>ì— ê¸°ë¡</li> </ul> </li> <li>d : ì•ì„œ<code class="language-plaintext highlighter-rouge"> free</code>í•œ ì²­í¬ë“¤ì´ <code class="language-plaintext highlighter-rouge">unsorted bin</code>ì—ì„œ ê°ê°ì˜ <code class="language-plaintext highlighter-rouge">large bin</code>ê³¼ <code class="language-plaintext highlighter-rouge">small bin</code>ì— ë°°ì¹˜ë  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” íŒ¨í‚·</li> <li>e : 27ê°œì˜ ìŒì„ ì´ìš©í•´ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ íŒ¨í‚·(ì•ì„œ ì•Œì•„ë³¸ í™ ë ˆì´ì•„ì›ƒ ì¡°ì‘ì„ ìœ„í•œ ì‹œí€€ìŠ¤ ìˆ˜í–‰ : <code class="language-plaintext highlighter-rouge">malloc(~4KB)</code>, <code class="language-plaintext highlighter-rouge">malloc(304)</code>, <code class="language-plaintext highlighter-rouge">malloc(~4KB), malloc(304))</code></li> </ul> <h4 id="timing-strategy"> <a href="#timing-strategy" class="anchor-head"></a> Timing strategy </h4> <p>ì—¬ëŸ¬ ì œì•½ ì‚¬í•­ ë•Œë¬¸ì— ê²°ê³¼ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ í•¨ìˆ˜ì—ì„œ ì‹œê°„ì„ ì¸¡ì •í•˜ì—¬ íŒ¨í‚· ì „ì†¡ íƒ€ì´ë°ì„ ë§ì¶”ê²Œë©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mi">88</span> <span class="nf">userauth_pubkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssh</span> <span class="o">*</span><span class="n">ssh</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">)</span>
 <span class="mi">89</span> <span class="p">{</span>
<span class="p">...</span>
<span class="mi">138</span>         <span class="k">if</span> <span class="p">(</span><span class="n">pktype</span> <span class="o">==</span> <span class="n">KEY_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">139</span>                 <span class="cm">/* this is perfectly legal */</span>
<span class="mi">140</span>                 <span class="n">verbose_f</span><span class="p">(</span><span class="s">"unsupported public key algorithm: %s"</span><span class="p">,</span> <span class="n">pkalg</span><span class="p">);</span>
<span class="mi">141</span>                 <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="mi">142</span>         <span class="p">}</span>
<span class="mi">143</span>         <span class="nf">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">sshkey_from_blob</span><span class="p">(</span><span class="n">pkblob</span><span class="p">,</span> <span class="n">blen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">144</span>                 <span class="n">error_fr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">"parse key"</span><span class="p">);</span>
<span class="mi">145</span>                 <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="mi">146</span>         <span class="p">}</span>
<span class="p">...</span>
<span class="mi">151</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">pktype</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">152</span>                 <span class="n">error_f</span><span class="p">(</span><span class="s">"type mismatch for decoded key "</span>
<span class="mi">153</span>                     <span class="s">"(received %d, expected %d)"</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">pktype</span><span class="p">);</span>
<span class="mi">154</span>                 <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="mi">155</span>         <span class="p">}</span>
</code></pre></div></div> <ul> <li>ê³µê°œ í‚¤ íŒ¨í‚· ì¤‘ <code class="language-plaintext highlighter-rouge">pktype</code>ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œë” ë°ì´í„°ë¥¼ ì„¤ì •í•´ 138~142í–‰ì—ì„œ íŒ¨í‚· ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œ í•©ë‹ˆë‹¤.</li> <li>ë‘ ë²ˆì§¸ë¡œ ê³µê°œ í‚¤ íŒ¨í‚· ì¤‘ <code class="language-plaintext highlighter-rouge">key-&gt;type</code>ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œë” ë°ì´í„°ë¥¼ ì„¤ì •í•´ 151~155í–‰ì—ì„œ íŒ¨í‚· ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œ í•©ë‹ˆë‹¤.</li> <li>ì´ë•Œ 143í–‰ì— ì¡´ì¬í•˜ëŠ” <code class="language-plaintext highlighter-rouge">sshkey_from_blob</code>ì€ ê³µê°œí‚¤ë¥¼ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜ë¡œ ìœ„ì—ì„œ ì•Œì•„ë³¸ ì–‘ì˜†ì—ìˆëŠ” ë‘ í•¨ìˆ˜ì˜ ì‘ë‹µ ì‹œê°„ì˜ ì°¨ê°€ <code class="language-plaintext highlighter-rouge">sshd</code>ê°€ ê³µê°œ í‚¤ë¥¼ íŒŒì‹±í•˜ëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ë©ë‹ˆë‹¤.</li> <li>ì´ë¥¼ í†µí•´ ë§ˆì§€ë§‰ íŒ¨í‚·ì˜ ì „ì†¡ì‹œê°„ì„ ì¡°ì ˆí•©ë‹ˆë‹¤.</li> </ul> <p><code class="language-plaintext highlighter-rouge">sshkey_from_blob</code>ì€ ë‹¤ìŒê³¼ ê°™ì€ íë¦„ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">cert_parse</code>ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p> <details> <summary>sshkey.c:sshkey_from_blob</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">sshkey_from_blob</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">blob</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">blen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sshkey</span> <span class="o">**</span><span class="n">keyp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">sshbuf_from</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">blen</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SSH_ERR_ALLOC_FAIL</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">sshkey_from_blob_internal</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">keyp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sshbuf_free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <details> <summary>sshkey.c:sshkey_from_blob_internal</summary> <div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span>
<span class="nf">sshkey_from_blob_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sshkey</span> <span class="o">**</span><span class="n">keyp</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">allow_cert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ktype</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sshkey</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sshbuf</span> <span class="o">*</span><span class="n">copy</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sshkey_impl</span> <span class="o">*</span><span class="n">impl</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_PK </span><span class="cm">/* XXX */</span><span class="cp">
</span>	<span class="n">sshbuf_dump</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">keyp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">keyp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">copy</span> <span class="o">=</span> <span class="n">sshbuf_fromb</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_ALLOC_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sshbuf_get_cstring</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_INVALID_FORMAT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">sshkey_type_from_name</span><span class="p">(</span><span class="n">ktype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_cert</span> <span class="o">&amp;&amp;</span> <span class="n">sshkey_type_is_cert</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_KEY_CERT_INVALID_SIGN_KEY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">impl</span> <span class="o">=</span> <span class="n">sshkey_impl_from_type</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_KEY_TYPE_UNKNOWN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">=</span> <span class="n">sshkey_new</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_ALLOC_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sshkey_type_is_cert</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Skip nonce that preceeds all certificates */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sshbuf_get_string_direct</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_INVALID_FORMAT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">impl</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">deserialize_public</span><span class="p">(</span><span class="n">ktype</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Parse certificate potion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sshkey_is_cert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cert_parse</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">copy</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sshbuf_len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SSH_ERR_INVALID_FORMAT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keyp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">keyp</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">sshbuf_free</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
	<span class="n">sshkey_free</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">ktype</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> </div> </div> </details> <p>ì‚¬ì‹¤ìƒ ìœ„ì—ì„œ ì•Œì•„ë³¸ ì œì•½ ì‚¬í•­ ë•Œë¬¸ì— í•´ë‹¹ ì·¨ì•½ì ì„ ì´ìš©í•˜ëŠ” ê²ƒì€ ë§ì´ í˜ë“¤ì–´ë³´ì…ë‹ˆë‹¤. ë˜í•œ í™˜ê²½ì— ëŒ€í•œ ì œì•½ ì—­ì‹œ í½ë‹ˆë‹¤. ì´ì œ PoCë¥¼ í™•ì¸í•´ë´…ì‹œë‹¤.</p> <h1 id="poc-analysis"> <a href="#poc-analysis" class="anchor-head"></a> PoC Analysis </h1> <p><a href="https://github.com/lflare/cve-2024-6387-poc/tree/master">PoC</a>ê°€ í˜„ì¬ ê³µê°œëœ ìƒíƒœì§€ë§Œ ì˜ë„ì ìœ¼ë¡œ í•´ë‹¹ PoCëŠ” ì‘ë™í•˜ì§€ì•Šê²Œ ì‘ì„±ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p> <p align="center"><img width="100%" src="/assets/img/CVE-2024-6387/commit_history.png" /></p> <p><br /></p> <p>PoCëŠ” ì•ì„œ ì•Œì•„ë³¸ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ íŒ¨í‚·ì„ ì „ì†¡í•©ë‹ˆë‹¤.</p> <ul> <li>a : <code class="language-plaintext highlighter-rouge">tcache</code> í¬ê¸°ì˜ ì²­í¬ë¥¼ <code class="language-plaintext highlighter-rouge">malloc</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">free</code>í•˜ê¸° ìœ„í•œ íŒ¨í‚·</li> <li>b : ë‹¤ì–‘í•œ í¬ê¸°(<code class="language-plaintext highlighter-rouge">~8KB</code>, <code class="language-plaintext highlighter-rouge">320B hole</code>)ì˜ ì²­í¬ë¥¼ <code class="language-plaintext highlighter-rouge">malloc</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">free</code>í•˜ì—¬ 27ê°œì˜ <code class="language-plaintext highlighter-rouge">large hole</code>, <code class="language-plaintext highlighter-rouge">small hole</code> ìŒì„ ë§Œë“¤ê¸° ìœ„í•œ íŒ¨í‚·</li> <li>c : ì´ë¯¸ <code class="language-plaintext highlighter-rouge">free</code>ëœ ì²­í¬ë“¤ì´ ìµìŠ¤í”Œë¡œì‡ì—ì„œ ì¡°ì‘ëœ ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë¯¸ë¦¬ ê°’ë“¤ì„ ì„¸íŒ…í•´ë‘ëŠ” íŒ¨í‚· <ul> <li><code class="language-plaintext highlighter-rouge">remainder</code>ì˜ í¬ê¸°ë¥¼ í¬ê²Œ ë§Œë“¤ ê°€ì§œ í—¤ë”ë¥¼ ì¤‘ê°„ì— ê¸°ë¡</li> <li><code class="language-plaintext highlighter-rouge">glibc</code>ì˜ ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ê¸° ìœ„í•œ <code class="language-plaintext highlighter-rouge">footer</code>ë¥¼ <code class="language-plaintext highlighter-rouge">small hole</code> ë ë¶€ë¶„ì— ê¸°ë¡</li> <li><code class="language-plaintext highlighter-rouge">fake vtable</code>ê³¼ <code class="language-plaintext highlighter-rouge">_codecvt</code> í¬ì¸í„°ë¥¼ <code class="language-plaintext highlighter-rouge">small hole</code>ì— ê¸°ë¡</li> </ul> </li> <li>d : ì•ì„œ <code class="language-plaintext highlighter-rouge">free</code>í•œ ì²­í¬ë“¤ì´ <code class="language-plaintext highlighter-rouge">unsorted bin</code>ì—ì„œ ê°ê°ì˜ <code class="language-plaintext highlighter-rouge">large bin</code>ê³¼ <code class="language-plaintext highlighter-rouge">small bin</code>ì— ë°°ì¹˜ë  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” íŒ¨í‚·</li> <li>e : 27ê°œì˜ ìŒì„ ì´ìš©í•´ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ íŒ¨í‚·(ì•ì„œ ì•Œì•„ë³¸ í™ ë ˆì´ì•„ì›ƒ ì¡°ì‘ì„ ìœ„í•œ ì‹œí€€ìŠ¤ ìˆ˜í–‰ : <code class="language-plaintext highlighter-rouge">malloc(~4KB)</code>, <code class="language-plaintext highlighter-rouge">malloc(304)</code>, <code class="language-plaintext highlighter-rouge">malloc(~4KB), malloc(304))</code></li> </ul> <p>PoCì—ì„œ ì—­ì‹œ <code class="language-plaintext highlighter-rouge">glibc</code>ë¥¼ ë‹¤ìŒê³¼ ê°™ì€ ë‘ ê°œì˜ ì£¼ì†Œì¤‘ í•˜ë‚˜ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Possible glibc base addresses (for ASLR bypass)</span>
<span class="kt">uint64_t</span> <span class="n">GLIBC_BASES</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xb7200000</span><span class="p">,</span> <span class="mh">0xb7400000</span> <span class="p">};</span>
<span class="kt">int</span> <span class="n">NUM_GLIBC_BASES</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">GLIBC_BASES</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">GLIBC_BASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">main</code> í•¨ìˆ˜ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„ì„ ì‚´í´ë´…ì‹œë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="p">...</span>
          <span class="n">prepare_heap</span> <span class="p">(</span><span class="n">sock</span><span class="p">);</span>
          <span class="n">time_final_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parsing_time</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">attempt_race_condition</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">parsing_time</span><span class="p">,</span> <span class="n">glibc_base</span><span class="p">))</span>
            <span class="p">{</span>
              <span class="n">printf</span> <span class="p">(</span><span class="s">"Possible exploitation success on attempt %d with glibc "</span>
                      <span class="s">"base 0x%lx!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                      <span class="n">attempt</span><span class="p">,</span> <span class="n">glibc_base</span><span class="p">);</span>
              <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>ìœ„ì— ë‚˜íƒ€ë‚œ í•¨ìˆ˜ë“¤ ì¤‘ <code class="language-plaintext highlighter-rouge">prepare_heap</code> í•¨ìˆ˜ì—ì„œ a~dì˜ ì—­í• ì„ í•˜ëŠ” íŒ¨í‚·ë“¤ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">prepare_heap</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Packet a: Allocate and free tcache chunks</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tcache_chunk</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
      <span class="n">memset</span> <span class="p">(</span><span class="n">tcache_chunk</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tcache_chunk</span><span class="p">));</span>
      <span class="n">send_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">tcache_chunk</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tcache_chunk</span><span class="p">));</span>
      <span class="c1">// These will be freed by the server, populating tcache</span>
    <span class="p">}</span>

  <span class="c1">// Packet b: Create 27 pairs of large (~8KB) and small (320B) holes</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Allocate large chunk (~8KB)</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">large_hole</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span>
      <span class="n">memset</span> <span class="p">(</span><span class="n">large_hole</span><span class="p">,</span> <span class="sc">'B'</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">large_hole</span><span class="p">));</span>
      <span class="n">send_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">large_hole</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">large_hole</span><span class="p">));</span>

      <span class="c1">// Allocate small chunk (320B)</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">small_hole</span><span class="p">[</span><span class="mi">320</span><span class="p">];</span>
      <span class="n">memset</span> <span class="p">(</span><span class="n">small_hole</span><span class="p">,</span> <span class="sc">'C'</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">small_hole</span><span class="p">));</span>
      <span class="n">send_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">small_hole</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">small_hole</span><span class="p">));</span>
    <span class="p">}</span>

  <span class="c1">// Packet c: Write fake headers, footers, vtable and _codecvt pointers</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fake_data</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
      <span class="n">create_fake_file_structure</span> <span class="p">(</span><span class="n">fake_data</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">fake_data</span><span class="p">),</span>
                                  <span class="n">GLIBC_BASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">send_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">fake_data</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">fake_data</span><span class="p">));</span>
    <span class="p">}</span>

  <span class="c1">// Packet d: Ensure holes are in correct malloc bins (send ~256KB string)</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">large_string</span><span class="p">[</span><span class="n">MAX_PACKET_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="n">memset</span> <span class="p">(</span><span class="n">large_string</span><span class="p">,</span> <span class="sc">'E'</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">large_string</span><span class="p">));</span>
  <span class="n">send_packet</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">large_string</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">large_string</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">prepare_heap</code>ì´ ì™„ë£Œë˜ë©´ <code class="language-plaintext highlighter-rouge">time_final_paket</code> í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ê³µê°œí‚¤ê°€ íŒŒì‹±ë˜ëŠ” íƒ€ì´ë°ì„ ì•Œì•„ëƒ…ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">time_final_packet</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">parsing_time</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">time_before</span> <span class="o">=</span> <span class="n">measure_response_time</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">time_after</span> <span class="o">=</span> <span class="n">measure_response_time</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="o">*</span><span class="n">parsing_time</span> <span class="o">=</span> <span class="n">time_after</span> <span class="o">-</span> <span class="n">time_before</span><span class="p">;</span>

  <span class="n">printf</span> <span class="p">(</span><span class="s">"Estimated parsing time: %.6f seconds</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">parsing_time</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>ìœ„ì—ì„œ ì•Œì•„ë‚¸ íƒ€ì´ë°ì„ ê¸°ë°˜ìœ¼ë¡œ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="n">attempt_race_condition</span> <span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">parsing_time</span><span class="p">,</span> <span class="n">glibc_base</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div> <h1 id="patch"> <a href="#patch" class="anchor-head"></a> Patch </h1> <p><code class="language-plaintext highlighter-rouge">sshd.c</code>ì— ìœ„ì¹˜í•œ <a href="https://github.com/openssh/openssh-portable/blob/V_9_7/sshd.c#L353">grace_alarm_handler</a> í•¨ìˆ˜ê°€ <code class="language-plaintext highlighter-rouge">sshd-session.c</code>ë¡œ ì˜®ê²¨ê°€ë©° ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Signal handler for the alarm after the login grace period has expired.
 * As usual, this may only take signal-safe actions, even though it is
 * terminal.
 */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">grace_alarm_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*
	 * Try to kill any processes that we have spawned, E.g. authorized
	 * keys command helpers or privsep children.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getpgid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">getpid</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">;</span>

		<span class="cm">/* mask all other signals while in handler */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
		<span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_IGN</span><span class="p">;</span>
		<span class="n">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
		<span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_RESTART</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">_exit</span><span class="p">(</span><span class="n">EXIT_LOGIN_GRACE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <h1 id="references"> <a href="#references" class="anchor-head"></a> References </h1> <ul> <li><a href="https://www.openssh.com/txt/release-9.8">https://www.openssh.com/txt/release-9.8</a><br /></li> <li><a href="https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt">https://www.qualys.com/2024/07/01/cve-2024-6387/regresshion.txt</a></li> </ul> </div> </article> </main> <small class="post-updated-at">updated_at 05-11-2024</small> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/CVE-2024-38063/" > <div class="nav-arrow">Previous</div> <span class="post-title">CVE-2024-38063 - Analysis of Windows TCP/IP IPv6 Vulnerabilities</span> </a> <a class="post-nav-item post-nav-next" href="/CVE-2021-24086/"> <div class="nav-arrow">Next</div> <span class="post-title">CVE-2021-24086 - Analysis of Windows TCP/IP IPv6 Denial of Service (DoS) Vulnerability</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2024</span> <small class="footer_copyright"> <!-- KlisÃ© Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisÃ©</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
