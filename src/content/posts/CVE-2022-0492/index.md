---
title: CVE-2022-0492
published: 2025-07-20 14:30:00 +09:00
description: "Analysis of Linux Kernel Cgroups-v1 Vulnerability"
tags: ["1-day", "exploit", "linux kernel", "cgroups"]
image: ./title.png

category: Linux Kernel
draft: false
---

ì‚¬ì •ìœ¼ë¡œ ëª‡ ê°œì›”ë§Œì— ê¸€ì„ ì˜¬ë¦¬ë„¤ìš”.ğŸ˜… ê·¸ë˜ë„ ê´€ë ¨ í™œë™ì€ ë©ˆì¶”ì§€ ì•Šê³  ê³„ì†í•´ì„œ ì´ì–´ë‚˜ê°€ê³  ìˆë‹µë‹ˆë‹¤.ğŸ«  ì ê¹ì˜ í¬ìŠ¤íŒ…ì„ ì‰¬ëŠ” ì‹œê°„ì„ í—ˆë½í•´ì£¼ì‹  íŒ€ì¥ë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤..

# Intro

TOOR íŒ€ í™œë™ì„ í•˜ë©° ë¶„ì„í•˜ê²Œ ëœ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬ ìš°íšŒ ì·¨ì•½ì  ê´€ë ¨ ê¸€ì…ë‹ˆë‹¤.

<p align="center"><img src="/assets/img/toor.png"/></p>

ì´ë²ˆì— ì•Œì•„ë³¼ ì›ë°ì´ ì·¨ì•½ì ì€ <a href="https://nvd.nist.gov/vuln/detail/cve-2022-0492">2022ë…„ 3ì›” 3ì¼ì— ê³µê°œëœ</a> ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬ ìš°íšŒ ì·¨ì•½ì ì…ë‹ˆë‹¤.

ê³µê²©ìëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ì œê³µí•˜ëŠ” cgroups ë²„ì „ 1ì´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì—ì„œ ì·¨ì•½ì ì„ ì•…ìš©í•˜ì—¬ ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ íƒˆì¶œì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë³¸ ê¸€ì€ ì„ í–‰ ì—°êµ¬ë¥¼ ì§„í–‰í•˜ì‹  ë‹¤ë¥¸ ì—°êµ¬ì›ë¶„ë“¤ì˜ ê¸€ë“¤ì„ ì½ê³  ì œ ë‚˜ë¦„ ë¶„ì„ì„ ì§„í–‰í•˜ë©° ì·¨ì•½ì ì„ ê³µë¶€í•˜ë©° ì´í•´í•˜ê³  ì •ë¦¬í•´ë³¸ ê²°ê³¼ë¡œ ì‘ì„±í•˜ê²Œëœ ê¸€ì…ë‹ˆë‹¤. ë‚˜ë¦„ì˜ ë¶„ì„ì„ í•´ë´¤ì§€ë§Œ ë§ì§€ ì•ŠëŠ” ë¶€ë¶„ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë©°, ë§Œì•½ ì´ë¥¼ ë°œê²¬í•˜ì…¨ì„ ì‹œ í”¼ë“œë°±í•´ì£¼ì‹œë©´ ì ê·¹ ë°˜ì˜í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì·¨ì•½ì  ë° PoC ë¶„ì„ì— ë§ì€ ë„ì›€ì´ëœ ìë£Œë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- <a href="https://www.hackthebox.com/blog/cve-2022-04920-carpe-diem-explained">https://www.hackthebox.com/blog/cve-2022-04920-carpe-diem-explained</a>
- <a href="https://blog.alyac.co.kr/4538">https://blog.alyac.co.kr/4538</a>
- <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=24f6008564183aa120d07c03d9289519c2fe02af">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=24f6008564183aa120d07c03d9289519c2fe02af</a>
- <a href="https://github.com/T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC/tree/master">https://github.com/T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC/tree/master</a>

# Vuln

- CVE-ID : <a href="https://nvd.nist.gov/vuln/detail/cve-2022-0492">CVE-2022-0492</a>
- CWE : <a href="http://cwe.mitre.org/data/definitions/862.html">CWE-862</a>, <a href="http://cwe.mitre.org/data/definitions/287.html">CWE-287</a>

# Background

CVE-2022-0492ë¥¼ ì´í•´í•˜ê¸° ìœ„í•œ ìµœì†Œí•œì˜ ê¸°ë°˜ ì§€ì‹ì— ëŒ€í•´ì„œ ì•Œì•„ë´…ì‹œë‹¤.

## cgroups-v1

cgroups version 1ì€ 2007ë…„ì— ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ë³‘í•©ëœ ê¸°ëŠ¥ì…ë‹ˆë‹¤. cgroupsì„ í†µí•´ì„œ CPU, ë©”ëª¨ë¦¬ ë“±ì˜ ìì› ì‚¬ìš©ëŸ‰ë“±ì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë™ì¼í•œ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì¸ í”„ë¡œì„¸ìŠ¤, í”„ë¡œì„¸ìŠ¤ ê³„ì¸µë“¤ì€ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì œí•œ ì •ì±…ì„ ê°–ê²Œ ë©ë‹ˆë‹¤. 

## notify_on_release

`notify_on_release`ëŠ” cgroups ì„œë¸Œ ì‹œìŠ¤í…œì— ì§€ì •í•  ìˆ˜ ìˆëŠ” í”Œë˜ê·¸ì…ë‹ˆë‹¤. í•´ë‹¹ í”Œë˜ê·¸ê°€ í™œì„±í™”ë˜ì–´ ìˆì„ ê²½ìš° cgroupìœ¼ë¡œ ë¬¶ì¸ ë§ˆì§€ë§‰ íƒœìŠ¤í¬ê°€ ì—†ì–´ì§ˆ ë•Œ(ì¢…ë£Œ í˜¹ì€ ë‹¤ë¥¸ cgroupìœ¼ë¡œ ì´ë™ë  ë•Œ), ì»¤ë„ì—ì„œëŠ” í•´ë‹¹ cgroup ê³„ì¸µì˜ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì— ì¡´ì¬í•˜ëŠ” `release_agent`ì— ì‘ì„±ëœ ëª…ë ¹ì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ì„œ cgroupì€ ë¹„ì–´ë²„ë¦° í•´ë‹¹ cgroupì— ëŒ€í•œ ì •ë¦¬ í˜¹ì€ í›„ ì²˜ë¦¬ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

# RCA

ì·¨ì•½ì ì€ ì»¨í…Œì´ë„ˆì™€ ê°™ì€ ê²©ë¦¬ëœ í™˜ê²½ì˜ ì‚¬ìš©ìê°€ capability ì œì•½ì´ ìˆëŠ” ìƒíƒœì˜ ë£¨íŠ¸ ê¶Œí•œì„ ê°–ê³  ìˆê±°ë‚˜ ë˜ëŠ” `CAP_DAC_OVERRIDE` caabilityë¥¼ ê°–ê³  ìˆì„ ê²½ìš° ì•…ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. 

ì´ëŠ” í•´ë‹¹ ì»¤ë°‹ ë””ìŠ¤í¬ë¦½ì…˜ì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
cgroup-v1: Require capabilities to set release_agent
The cgroup release_agent is called with call_usermodehelper.  The function
call_usermodehelper starts the release_agent with a full set fo capabilities.
Therefore require capabilities when setting the release_agaent.

Reported-by: Tabitha Sable <tabitha.c.sable@gmail.com>
Tested-by: Tabitha Sable <tabitha.c.sable@gmail.com>
Fixes: 81a6a5cdd2c5 ("Task Control Groups: automatic userspace notification of idle cgroups")
Cc: stable@vger.kernel.org # v2.6.24+
Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
```

ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ” cgroupì˜ ë£¨íŠ¸ ê²½ë¡œì— release_agentê°€ ìˆëŠ” ê²½ìš° ë£¨íŠ¸ ê¶Œí•œì„ ê°–ê³  ìˆëŠ” ì»¨í…Œì´ë„ˆ ë‚´ì˜ ì‚¬ìš©ìê°€ í•´ë‹¹ íŒŒì¼ì„ ìˆ˜ì •í•˜ëŠ” ê³¼ì •ì—ì„œ ë‹¤ìŒ ì·¨ì•½ì  íŒ¨ì¹˜ì—ì„œ ë³´ëŠ” ê²ƒê³¼ ê°™ì´ capability ì²´í¬ê°€ ë¯¸í¡í•©ë‹ˆë‹¤. 
ì¦‰, release_agentë¡œ ì¸í•´ ì‹¤í–‰ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ëŠ” ëª¨ë“  capabilityë¥¼ ê°–ì§€ë§Œ, ì´ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆëŠ” ìˆ˜ì • ê¸°ëŠ¥ì—ëŠ” capability ì œì•½ì´ ëˆ„ë½ë˜ì–´ìˆìŠµë‹ˆë‹¤.

```diff
diff --git a/kernel/cgroup/cgroup-v1.c b/kernel/cgroup/cgroup-v1.c
index 41e0837a5a0bda..0e877dbcfeea9c 100644
--- a/kernel/cgroup/cgroup-v1.c
+++ b/kernel/cgroup/cgroup-v1.c
@@ -549,6 +549,14 @@ static ssize_t cgroup_release_agent_write(struct kernfs_open_file *of,
 
 	BUILD_BUG_ON(sizeof(cgrp->root->release_agent_path) < PATH_MAX);
 
+	/*
+	 * Release agent gets called with all capabilities,
+	 * require capabilities to set release agent.
+	 */
+	if ((of->file->f_cred->user_ns != &init_user_ns) ||
+	    !capable(CAP_SYS_ADMIN))
+		return -EPERM;
+
 	cgrp = cgroup_kn_lock_live(of->kn, false);
 	if (!cgrp)
 		return -ENODEV;
```
ì´ë¡œ ì¸í•´ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ëª¨ë“  capability(CAP_SYS_ADMIN)ë¥¼ ê°–ê³  ìˆì§€ ì•Šì€ `root` í˜¹ì€ `CAP_DAC_OVERRIDE` capabilityë§Œ ê°–ëŠ” ê³µê²©ìëŠ” release_agentë¥¼ ìˆ˜ì •í•˜ì—¬ ëª¨ë“  capability(CAP_SYS_ADMIN)ë¥¼ ê°–ëŠ” ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ê²©ë¦¬ëœ í™˜ê²½ì„ íƒˆì¶œí•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# PoC

ì—´ì‹¬íˆ ì‘ì„±ì¤‘ ğŸ˜µâ€ğŸ’«

# Video

ì—´ì‹¬íˆ ì‘ì„±ì¤‘ ğŸ˜µâ€ğŸ’«

# Patch

ì•ì„  íŒ¨ì¹˜ì—ì„œ ë´¤ ë“¯, release_agentë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•œ ê¶Œí•œì„ ì²´í¬í•©ë‹ˆë‹¤. ì´ë¡œì¨ ê³µê²©ìëŠ” íŒ¨ì¹˜ ì´ì „ì²˜ëŸ¼ ì œí•œëœ Capabilityë¥¼ ê°€ì§€ê³  release_agentë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

```diff
diff --git a/kernel/cgroup/cgroup-v1.c b/kernel/cgroup/cgroup-v1.c
index 41e0837a5a0bda..0e877dbcfeea9c 100644
--- a/kernel/cgroup/cgroup-v1.c
+++ b/kernel/cgroup/cgroup-v1.c
@@ -549,6 +549,14 @@ static ssize_t cgroup_release_agent_write(struct kernfs_open_file *of,
 
 	BUILD_BUG_ON(sizeof(cgrp->root->release_agent_path) < PATH_MAX);
 
+	/*
+	 * Release agent gets called with all capabilities,
+	 * require capabilities to set release agent.
+	 */
+	if ((of->file->f_cred->user_ns != &init_user_ns) ||
+	    !capable(CAP_SYS_ADMIN))
+		return -EPERM;
+
 	cgrp = cgroup_kn_lock_live(of->kn, false);
 	if (!cgrp)
 		return -ENODEV;
```

# Mitigation

- ì·¨ì•½ì ì— ëŒ€í•œ íŒ¨ì¹˜ê°€ ì ìš©ëœ ì»¤ë„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- cgroup-v1ì„ ë¹„í™œì„±í™” í•©ë‹ˆë‹¤.
- ì»¨í…Œì´ë„ˆì— ëŒ€í•œ Capabilityì„ ì œí•œí•©ë‹ˆë‹¤.
- ì»¤ë„ì´ ì œê³µí•˜ëŠ” ë³´ì•ˆ ê¸°ëŠ¥ë“±ì„ í™œì„±í™” ì‹œí‚µë‹ˆë‹¤. (Apparmor, SELinux, Seccmop)

# References

- <a href="https://nvd.nist.gov/vuln/detail/cve-2022-0492">https://nvd.nist.gov/vuln/detail/cve-2022-0492</a>
- <a href="https://www.hackthebox.com/blog/cve-2022-04920-carpe-diem-explained">https://www.hackthebox.com/blog/cve-2022-04920-carpe-diem-explained</a>
- <a href="https://blog.alyac.co.kr/4538">https://blog.alyac.co.kr/4538</a>
- <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=24f6008564183aa120d07c03d9289519c2fe02af">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=24f6008564183aa120d07c03d9289519c2fe02af</a>
- <a href="https://github.com/T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC/tree/master">https://github.com/T1erno/CVE-2022-0492-Docker-Breakout-Checker-and-PoC/tree/master</a>
